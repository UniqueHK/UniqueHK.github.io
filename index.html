<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>宽视角</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="年轻是什么？就是越挫越勇！">
<meta property="og:type" content="website">
<meta property="og:title" content="宽视角">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="宽视角">
<meta property="og:description" content="年轻是什么？就是越挫越勇！">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="宽视角">
<meta name="twitter:description" content="年轻是什么？就是越挫越勇！">
  
    <link rel="alternative" href="/atom.xml" title="宽视角" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	
		<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
			<label>Search</label>
			<input type="text" id="st-search-input" class="st-default-search-input st-search-input_my" maxlength="30" placeholder="Search" />
		</form>
	
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/4168558?v=3&amp;s=460" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">宽视角</a></h1>
		</hgroup>

		
        <h3 style="font-weight:bold;font-style:italic;" class="header-subtitle">listen</h3>
        

		
		<p class="header-subtitle">年轻是什么？就是越挫越勇！</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/listen-lavender" title="github">github</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/" style="font-size: 10px;">==</a> <a href="/tags/DAG/" style="font-size: 10px;">DAG</a> <a href="/tags/FP/" style="font-size: 10px;">FP</a> <a href="/tags/LRU-cache/" style="font-size: 10px;">LRU cache</a> <a href="/tags/Newton-iteration/" style="font-size: 10px;">Newton iteration</a> <a href="/tags/OOP/" style="font-size: 10px;">OOP</a> <a href="/tags/Slice分布式/" style="font-size: 10px;">Slice分布式</a> <a href="/tags/Time-Quantum/" style="font-size: 10px;">Time Quantum</a> <a href="/tags/async-task/" style="font-size: 10px;">async task</a> <a href="/tags/asynchronous/" style="font-size: 10px;">asynchronous</a> <a href="/tags/asyncio/" style="font-size: 10px;">asyncio</a> <a href="/tags/authority/" style="font-size: 10px;">authority</a> <a href="/tags/background/" style="font-size: 10px;">background</a> <a href="/tags/beanstalkd/" style="font-size: 10px;">beanstalkd</a> <a href="/tags/binary-search/" style="font-size: 10px;">binary search</a> <a href="/tags/bit/" style="font-size: 10px;">bit</a> <a href="/tags/bitmap/" style="font-size: 20px;">bitmap</a> <a href="/tags/brpop/" style="font-size: 10px;">brpop</a> <a href="/tags/cache-algorithm/" style="font-size: 10px;">cache algorithm</a> <a href="/tags/cell/" style="font-size: 10px;">cell</a> <a href="/tags/column/" style="font-size: 10px;">column</a> <a href="/tags/comet-streaming/" style="font-size: 10px;">comet streaming</a> <a href="/tags/complicated/" style="font-size: 10px;">complicated</a> <a href="/tags/concurrently/" style="font-size: 10px;">concurrently</a> <a href="/tags/context/" style="font-size: 10px;">context</a> <a href="/tags/coroutine/" style="font-size: 10px;">coroutine</a> <a href="/tags/csrf/" style="font-size: 10px;">csrf</a> <a href="/tags/data-pipeline/" style="font-size: 10px;">data pipeline</a> <a href="/tags/datamodel/" style="font-size: 10px;">datamodel</a> <a href="/tags/distributed/" style="font-size: 10px;">distributed</a> <a href="/tags/dynamic/" style="font-size: 10px;">dynamic</a> <a href="/tags/extract/" style="font-size: 10px;">extract</a> <a href="/tags/flexible/" style="font-size: 10px;">flexible</a> <a href="/tags/frame/" style="font-size: 10px;">frame</a> <a href="/tags/gen-coroutine/" style="font-size: 10px;">gen.coroutine</a> <a href="/tags/goroutine/" style="font-size: 10px;">goroutine</a> <a href="/tags/greenlet/" style="font-size: 10px;">greenlet</a> <a href="/tags/gunicorn/" style="font-size: 10px;">gunicorn</a> <a href="/tags/hashtable/" style="font-size: 10px;">hashtable</a> <a href="/tags/hash优化/" style="font-size: 10px;">hash优化</a> <a href="/tags/hash制度/" style="font-size: 10px;">hash制度</a> <a href="/tags/header/" style="font-size: 10px;">header</a> <a href="/tags/http1-0/" style="font-size: 10px;">http1.0</a> <a href="/tags/http1-1/" style="font-size: 10px;">http1.1</a> <a href="/tags/http2-0/" style="font-size: 10px;">http2.0</a> <a href="/tags/include/" style="font-size: 10px;">include</a> <a href="/tags/index/" style="font-size: 20px;">index</a> <a href="/tags/interface/" style="font-size: 10px;">interface</a> <a href="/tags/ioloop/" style="font-size: 10px;">ioloop</a> <a href="/tags/is/" style="font-size: 10px;">is</a> <a href="/tags/json/" style="font-size: 10px;">json</a> <a href="/tags/judge/" style="font-size: 10px;">judge</a> <a href="/tags/keyexpired/" style="font-size: 10px;">keyexpired</a> <a href="/tags/learning/" style="font-size: 10px;">learning</a> <a href="/tags/level/" style="font-size: 20px;">level</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/long-polling/" style="font-size: 10px;">long polling</a> <a href="/tags/lpush/" style="font-size: 10px;">lpush</a> <a href="/tags/lxml/" style="font-size: 10px;">lxml</a> <a href="/tags/mergelist/" style="font-size: 10px;">mergelist</a> <a href="/tags/method/" style="font-size: 10px;">method</a> <a href="/tags/mongo/" style="font-size: 10px;">mongo</a> <a href="/tags/mongo-id/" style="font-size: 10px;">mongo_id</a> <a href="/tags/monitor/" style="font-size: 10px;">monitor</a> <a href="/tags/mq通信/" style="font-size: 10px;">mq通信</a> <a href="/tags/multi-process/" style="font-size: 10px;">multi process</a> <a href="/tags/nosql/" style="font-size: 10px;">nosql</a> <a href="/tags/object-oriented/" style="font-size: 10px;">object-oriented</a> <a href="/tags/off-schedule/" style="font-size: 10px;">off-schedule</a> <a href="/tags/package/" style="font-size: 10px;">package</a> <a href="/tags/parallel/" style="font-size: 10px;">parallel</a> <a href="/tags/parametrized/" style="font-size: 10px;">parametrized</a> <a href="/tags/performance/" style="font-size: 10px;">performance</a> <a href="/tags/phantomjs/" style="font-size: 10px;">phantomjs</a> <a href="/tags/pointer/" style="font-size: 10px;">pointer</a> <a href="/tags/pointerarray/" style="font-size: 10px;">pointerarray</a> <a href="/tags/powerful/" style="font-size: 10px;">powerful</a> <a href="/tags/priority/" style="font-size: 20px;">priority</a> <a href="/tags/procedure-oriented/" style="font-size: 10px;">procedure-oriented</a> <a href="/tags/property/" style="font-size: 10px;">property</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/queue/" style="font-size: 10px;">queue</a> <a href="/tags/recursive-struct/" style="font-size: 10px;">recursive struct</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/regex/" style="font-size: 10px;">regex</a> <a href="/tags/requests/" style="font-size: 10px;">requests</a> <a href="/tags/row/" style="font-size: 10px;">row</a> <a href="/tags/rpc通信/" style="font-size: 10px;">rpc通信</a> <a href="/tags/rwx/" style="font-size: 10px;">rwx</a> <a href="/tags/setter-getter/" style="font-size: 10px;">setter/getter</a> <a href="/tags/shell-script/" style="font-size: 10px;">shell script</a> <a href="/tags/signatures/" style="font-size: 10px;">signatures</a> <a href="/tags/specific-type/" style="font-size: 10px;">specific type</a> <a href="/tags/sqrt/" style="font-size: 10px;">sqrt</a> <a href="/tags/task-flow/" style="font-size: 10px;">task flow</a> <a href="/tags/threading/" style="font-size: 10px;">threading</a> <a href="/tags/type-assert/" style="font-size: 10px;">type assert</a> <a href="/tags/urlparameter/" style="font-size: 10px;">urlparameter</a> <a href="/tags/websocket/" style="font-size: 10px;">websocket</a> <a href="/tags/weight/" style="font-size: 10px;">weight</a> <a href="/tags/worthy/" style="font-size: 10px;">worthy</a> <a href="/tags/上/" style="font-size: 10px;">上</a> <a href="/tags/两小无猜/" style="font-size: 10px;">两小无猜</a> <a href="/tags/乌托邦/" style="font-size: 10px;">乌托邦</a> <a href="/tags/人生半坡/" style="font-size: 10px;">人生半坡</a> <a href="/tags/优先级/" style="font-size: 10px;">优先级</a> <a href="/tags/使用场景/" style="font-size: 10px;">使用场景</a> <a href="/tags/先验概率/" style="font-size: 10px;">先验概率</a> <a href="/tags/全概率/" style="font-size: 10px;">全概率</a> <a href="/tags/冲突/" style="font-size: 10px;">冲突</a> <a href="/tags/减法/" style="font-size: 10px;">减法</a> <a href="/tags/分布式/" style="font-size: 10px;">分布式</a> <a href="/tags/分支限界/" style="font-size: 10px;">分支限界</a> <a href="/tags/分治/" style="font-size: 10px;">分治</a> <a href="/tags/分类/" style="font-size: 10px;">分类</a> <a href="/tags/动态规划/" style="font-size: 10px;">动态规划</a> <a href="/tags/努力/" style="font-size: 10px;">努力</a> <a href="/tags/匿名变量/" style="font-size: 10px;">匿名变量</a> <a href="/tags/单线程/" style="font-size: 10px;">单线程</a> <a href="/tags/后验概率/" style="font-size: 10px;">后验概率</a> <a href="/tags/周星驰/" style="font-size: 10px;">周星驰</a> <a href="/tags/哈希/" style="font-size: 10px;">哈希</a> <a href="/tags/回溯/" style="font-size: 10px;">回溯</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a> <a href="/tags/富类hash/" style="font-size: 10px;">富类hash</a> <a href="/tags/小巧/" style="font-size: 10px;">小巧</a> <a href="/tags/嵌入式脚本/" style="font-size: 10px;">嵌入式脚本</a> <a href="/tags/异步IO/" style="font-size: 10px;">异步IO</a> <a href="/tags/张小凡/" style="font-size: 10px;">张小凡</a> <a href="/tags/性能/" style="font-size: 10px;">性能</a> <a href="/tags/排序/" style="font-size: 10px;">排序</a> <a href="/tags/新年快乐/" style="font-size: 10px;">新年快乐</a> <a href="/tags/条件查询/" style="font-size: 10px;">条件查询</a> <a href="/tags/条件概率/" style="font-size: 10px;">条件概率</a> <a href="/tags/浮夸/" style="font-size: 10px;">浮夸</a> <a href="/tags/混沌hash/" style="font-size: 10px;">混沌hash</a> <a href="/tags/热加载/" style="font-size: 10px;">热加载</a> <a href="/tags/父类方法调用子类方法/" style="font-size: 10px;">父类方法调用子类方法</a> <a href="/tags/状态/" style="font-size: 10px;">状态</a> <a href="/tags/田灵儿/" style="font-size: 10px;">田灵儿</a> <a href="/tags/自省自乐/" style="font-size: 10px;">自省自乐</a> <a href="/tags/自虐/" style="font-size: 10px;">自虐</a> <a href="/tags/贪心/" style="font-size: 10px;">贪心</a> <a href="/tags/转码/" style="font-size: 10px;">转码</a> <a href="/tags/阻塞完成/" style="font-size: 10px;">阻塞完成</a> <a href="/tags/随心随性/" style="font-size: 10px;">随心随性</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://braavos.me/">落在深海</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://sanyuesha.com/">三月沙</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">listen</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="https://avatars1.githubusercontent.com/u/4168558?v=3&amp;s=460" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">listen</h1>
			</hgroup>
			
			<p class="header-subtitle">年轻是什么？就是越挫越勇！</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/listen-lavender" title="github">github</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-airflow2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/04/12/airflow2/" class="article-date">
  	<time datetime="2020-04-12T02:35:13.000Z" itemprop="datePublished">2020-04-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/12/airflow2/">【译】Airflow的挑战者Prefect</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/2020/04/12/airflow2/airflow.png" alt="airflow"></p>
<p>在数据工程生态系统，Airflow一直是一个重要的工具，技术工作者也利用它开发了很多业务。它开创性地兼备严格DAG模型和Python的灵活性，从而广泛的适用现实生活中的工作流业务。然而，airflow被当做一个臃肿的批处理调度器来设计，目标使用者是团队原则上招来协调组织其他系统的数据工程师，因此其可用性受到了很大限制。</p>
<p>今天，许多数据工程师正在与分析人员更直接地合作。计算存储都是便宜的，使得试错成本低，注重实验。业务工作流快速动态变化。Airflow在许多事情上做对了，但是其核心假设从未预料到数据应用会变得如此多样化。很显然，它没有需要的语法接口来实现那些新的业务活动。</p>
<p>时间追溯到2016年Airflow如何改变来支撑新的多样化数据实践的讨论中，Prefect的第一次全面计划就此埋下种子。令人失望的是，Aiflow并未改进。我们开源了现代化的数据平台Prefect，早期的commit和评论反馈令我们很鼓舞。</p>
<p>我们知道用户关心关于Prefect与Airflow对比，尤其是考虑到Prefect的血统与Airflow相关。本文就是要强调Prefect引擎是如何用特定步骤解决一些Airflow无法解决的问题，并不是详尽的Prefect特性说明书，而是提供给熟悉Airflow的用户指南，解释Prefect解决问题的类似方法。我们希望对社区有用，尽可能地讨论解决了的问题和方法，对于开源仓库中当前不可用内容试图保持平衡和克制。</p>
<p>内容提要</p>
<ul>
<li>概览</li>
<li>API</li>
<li>调度和时间的关系</li>
<li>调度服务</li>
<li>数据流</li>
<li>参数化工作流</li>
<li>动态工作流</li>
<li>多版本工作流</li>
<li>本地测试</li>
<li>UI操作界面</li>
<li>总结</li>
</ul>
<h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><p>Airflow是为了按照固定的时间调度运行偏静态的、流转缓慢的工作流而设计，Airflow是达到了这个目的的优秀工具。Airflow也是第一个成功实现工作流即代码、灵活有用的范例。事实证明，无需借助配置文件，不使用DAG定义，也可实现工作流。</p>
<p>然而，从为了能处理的工作流类型来看，Airflow为设计工作流行为提供的语法接口很有限，尤其以现在的标准来看。用户为了实现业务，把业务强制地塞进Airflow模型会遇到麻烦。例如Airflow不能很好地满足以下场景：</p>
<ul>
<li>无调度或者脱离调度的DAG</li>
<li>同一时间多次并发启动的DAG</li>
<li>复杂分支逻辑的DAG</li>
<li>实时任务DAG</li>
<li>需要交换数据的DAG</li>
<li>参数化的DAG</li>
<li>动态的DAG</li>
</ul>
<p>如果你的使用场景与上述任何一种相似，无法直接使用Airflow，你需要在Airflow的抽象设计层面花费大量的工夫。因此，几乎每个中大规模的公司最终都会编写自定义的DSL，或者维护大量专有插件来满足内部多变的业务需求。这使得故障维护和升级困难。</p>
<p>Prefect是多年从事Airflow相关项目的经验成果。我们的研究覆盖了数百用户和公司，让我们发现了Airflow难以解决的隐患。通过设计支撑适合大多数业务场景的架构抽象，它最终实现了难以置信的友好和轻量的接口。</p>
<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><blockquote>
<p>  当工作流能够定义成代码时，他们变得更加<br>  易于维护，方便多版本追踪，好测试，可协作。</p>
<p>  – Airflow 官方文档</p>
</blockquote>
<p>生产工作流程是对复杂业务非常有益的事物，并且涉及技术范围内多个利益者。因此，让你工作流足够简单明了是很重要的。考虑到工作流在数据处理技术栈处处可用。Python是工作流语言的最优选择。Airflow是第一个认识到这一点的工具，并且用Python实现API。</p>
<p>但是，Airflow的API是命令式和基于类的。此外，由于Airflow对工作流可以说什么和不能做什么的限制（后面展开讲），编写Airflow DAG代码感觉像是在开发Airflow代码。</p>
<p>Prefect的基本理念是，如果开发者能够保证编写的业务代码按预期正常运行，可以当工作流系统不存在。只有当bug出现，程序抛异常，工作流管理的作用才显现出来。有鉴于此，工作流系统算是流程风险管理工具，并且设计合理的情况下，应该降低工作流系统代码对业务代码的显示侵入，除非开发者明确需要。无论哪种方式，工作流</p>
<p>所以Prefect的设计目标是在业务代码正确的情况下，尽量减少工作流系统代码侵入，同时在业务代码出错时，工作流系统工具代码能尽量帮助重回正轨。无论哪种方式，Prefect都可以为工作流提供相同级别的透明度和细节。</p>
<p>实现上述目标的一种方法是通过Prefect的功能性API。在此模式下，Prefect任务行为类似于函数。你可以添加输入，调用函数，并且使用函数的输出。简单到只用一行Prefect接口代码，就可以将Python函数转换为任务。任务之间的互相调用就像是Python函数一样自然地构建DAG，非常有Python风格。这使得将已有代码和脚本转换成全栈的Prefect工作流是轻车熟路的。</p>
<p>不用担心，Prefect同时还为Airflow用户提供全栈的过程式风格的API。过程式风格API对于复杂任务依赖的工作流是很有用，可以实现底层抽象控制。用户可以根据需求和倾向，来切换这两种风格。</p>
<h2 id="调度和时间的关系"><a href="#调度和时间的关系" class="headerlink" title="调度和时间的关系"></a>调度和时间的关系</h2><blockquote>
<p>  时间是一种幻想。午餐时间加倍。</p>
<p>  – 银河系漫游指南</p>
</blockquote>
<p>对于Airflow的新手来说，可能最常见的困惑是时间的使用。如果你运行Airflow教程例子，你会发现一直要纠结所有这些时间定义是什么意思呢？</p>
<p>Airflow严格依赖execution_date的时间定义。DAG要设置execution_date才可以运行，同一个execution_date的同一个DAG也不可能运行2次。你有没有一个DAG需要同时开始执行两次的呢？Airflow无法支持。你需要创建两个除了DAG ID之外完全相同的DAG，或者相隔1ms启动，或者使用有创造性的Hack方式使它起作用。</p>
<p>更令人困惑的是，execution_date并不是Airflow DAG的start_time，start_time=execution_date+一个周期间隔。这最初是由于ELT编排要求所致，execution_date为5月2日时间点的数据作业将在5月3日的同一时间点真正开始运行。时至今日，这都是用户尤其是新用户的最大困惑。</p>
<p>下一个时间点再运行产生的间隔设计起源于Airflow严格要求DAG有良好的执行计划。直到最近，它不可能运行脱离调度的DAG，因为调度器无法给这类DAG安排正确的start_time。临时运行也是可能的，只要这些临时运行的DAG_RUN不与同一个DAG下面的其他DAG_RUN有相同的start_time。</p>
<p>这意味着如果你有以下需求：</p>
<ul>
<li>不规则调度或者无调度的工作流</li>
<li>同一个工作流同时开始的多份运行</li>
<li>维护一个仅仅手工触发运行的工作流</li>
</ul>
<p>那么Airflow会是一个错误的工具。</p>
<blockquote>
<p>作为对比，Prefect将工作流当作可以任何时候执行、任意并发的对象。<br>调度计划只不过是一组预定义好的start_time，可以根据需求很灵活的定义简单或者复杂的调度计划。<br>如果确实需要工作流依赖于时间计划，只需要简单地将时间添加为工作流的参数</p>
</blockquote>
<h2 id="调度服务"><a href="#调度服务" class="headerlink" title="调度服务"></a>调度服务</h2><blockquote>
<p>R2-D2（星球大战的宇航技工机器人），你比起你作为一台奇怪的计算机器了解的更好。</p>
<p>–C-3PO（星球大战的礼仪机器人）</p>
</blockquote>
<p>Airflow的调度器是Airflow的核心骨架，对Airflow有性能影响。主要负责如下：</p>
<ul>
<li>每隔几秒钟重新分析一次DAG文件夹</li>
<li>检查DAG计划以确定DAG是否准备就绪</li>
<li>检查所有任务依赖项，以确定是否有任何任务可以运行</li>
<li>在数据库设置最终的DAG运行状态</li>
</ul>
<p>相反地，Prefect将这许多架构逻辑解耦到不同独立的模块中。</p>
<h3 id="Prefect-Flow-Scheduling"><a href="#Prefect-Flow-Scheduling" class="headerlink" title="Prefect Flow Scheduling"></a>Prefect Flow Scheduling</h3><p>Prefect工作流调度是很轻量的，我们只需要简单地创建一个新的工作流执行，并且设置成Scheduled状态。这就是Prefect的实际的唯一的责任，调度器绝对不会参与任何业务逻辑或者执行。</p>
<h3 id="Prefect-Flow-logic"><a href="#Prefect-Flow-logic" class="headerlink" title="Prefect Flow logic"></a>Prefect Flow logic</h3><p>Prefect流的逻辑是工作流里面的独立单元，调度程序绝不解析业务部分，也不会工作流相关的状态掺杂到业务里面。作为证据，你可以在本地对比运行业务代码添加工作流和未添加工作流的情况，发现添加工作流情况对业务执行几乎没有额外资源开销。</p>
<h3 id="Prefect-Task-scheduling"><a href="#Prefect-Task-scheduling" class="headerlink" title="Prefect Task scheduling"></a>Prefect Task scheduling</h3><p>当Prefect工作流在运行期间，只管调度属于自己的task，这非常重要：</p>
<ul>
<li>从工作流的架构抽象看，流对象是唯一一个适合承载这个责任的</li>
<li>减轻了中枢调度器的负担</li>
<li>针对各种独特场景做决策，例如动态生成任务</li>
<li>将执行细节交给Dask等外部系统负责</li>
</ul>
<p>最后一点很重要，尽管Airflow已经丰富地支持了多种执行环境，包括本地进程执行器、Celery执行器、Dask执行器、Kubernetes执行器，调度器仍然是Airflow工作流的瓶颈，调度器执行任何task都需要额外时间至少10s，5s用来标记已经就绪，5s用来提交执行。不管外部执行系统例如Dask集群有多大，Airflow会每隔10s调用task执行。</p>
<p>相比而言，Prefect采用了更现代化的方式。例如当Prefect在Dask上面执行的时候，我们利用Dask的毫秒级延迟任务调度器来尽快运行所有task，并且能充分利用Dask集群的并行度。实际上Prefect Cloud的默认部署规范是在Kubernetes中使用Dask集群，这也是可定制化的。</p>
<p>除性能外，这对于工作流的设计很有意义。Airflow鼓励设计庞大的task，Prefect倾向设计微型的模块化task，也保留了处理大型task的能力。</p>
<p>另外，当使用Prefect Clound运行带数据连接的task时，Task和工作流的执行者负责维护数据库连接的状态，而不是由调度器维护。</p>
<p>总结</p>
<ul>
<li><p>中心化的Airflow调度循环使得当任务启动遇到任务依赖处理时，会产生不小的延迟。如果使用场景只涉及到少数几个长时间运行的task，这完全没问题，但是如果你想执行一个包含有时间要求的大量task的DAG，这可能成为瓶颈。</p>
</li>
<li><p>Airflow将时间计划和工作流紧密耦合一起，这意味着你即使在本地运行DAG，也需要初始化数据库和调度服务。这当然是生产环境必要的步骤，但是对于业务代码的快速迭代和测试是很麻烦的。</p>
</li>
<li><p>Airflow调度器的集中特性形成了系统的单点故障。</p>
</li>
<li><p>循环重新解析DAG会造成严重的不一致，很有可能调度器将要执行的task，发现对应的DAG不存在。</p>
</li>
<li><p>集中调度意味着多个task之间无法通信（没有通信依赖关系解决方案）。</p>
</li>
</ul>
<h2 id="数据流"><a href="#数据流" class="headerlink" title="数据流"></a>数据流</h2><blockquote>
<p>  它是一个陷阱。</p>
<p>  – 《星球大战》贾尔·阿克巴上将</p>
</blockquote>
<p>Airflow最常见的用途之一建立某种数据管道，但是讽刺的是，Airflow并没有支持最好的方式实现它。</p>
<p>Airflow提供XCom，一个被设计用来task之间交换少量数据的工具。如果你希望task A告诉task B大量的数据写到云端的某个可见的位置，这是有用的。但是，当用户视图使用它建立数据管道，它成为Airflow的使用bug的主来源。</p>
<p>XCom使用管理员权限将可执行的序列化数据写到元数据的数据库，这有安全隐患。即使采用json格式，也还是有隐私问题。这个数据没有过期时间或者有效期限制，会造成性能和存储成本问题。更重要的是，使用XComs会在Airflow调度器不知情的情况，在task之间创建严格的上下游关系依赖。如果用户再不增加额外的人工关注，Airflow实际可能会用错误的顺序执行这些任务。考虑一下情况：</p>
<p>Airflow工具是无法确定某个任务明确依赖于另一个推类型任务的行为。如果用户没有明确向Airflow说明，调度器还是会无序运行这些任务。即使用户跟Airflow说明关系，Airflow也无法理解基于通信数据的依赖关系，而且当XCom推送失败，Airflow也不知道怎么响应。这是最常见的玄奥难解的Airflow bug之一。</p>
<p>不幸的是，经常有这种情况，Airflow新手过度使用XCom堵死了元数据库，我们看到过有人创建了10GB规模的数据，并用XCom传递给各种任务。DAG要是有10个task，一共会写100GB的数据到Airflow的元数据数据库。</p>
<p>Prefect将数据流设计为一等公民。task可以输入返回，Prefect用透明方式管理这些输入输出依赖。另外，Prefect永远不会将这些数据写入元数据数据库，相反的，阶段task在需要结果存储的时候，可以轻松配置安全的结果处理程序来管理。这样提供了许多好处：</p>
<ul>
<li>用户可以使用熟悉的Python风格编码</li>
<li>引擎知道依赖关系，这提供了更加透明的调试体验</li>
<li>因为Prefect允许使用数据流，并不意味着只能用它，所以仍然支持无依赖的Airflow风格，有时候鼓励使用它。</li>
<li>因为task可以交换数据，Prefect能支持更复杂的分支逻辑、丰富的task状态，并且在flow中task和runner之间执行更严格的约定</li>
</ul>
<h2 id="参数化工作流"><a href="#参数化工作流" class="headerlink" title="参数化工作流"></a>参数化工作流</h2><blockquote>
<p>  很抱歉Dave，恐怕我做不到。</p>
<p>  – 《2001太空漫游》超级电脑HAL9000</p>
</blockquote>
<p>有能力处理响应不同的输入是很方便的。例如，一个工作流可能就是一系列的步骤，可以重复处理不同API、数据库或者ID的信息，这些不同的数据需要复用相同的处理逻辑。甚至，你可能想用输入参数来影响工作流本身。</p>
<p>因为Airflow DAG要按固定的调度计划来执行，并且不接收输入调用参数，这不是Airflow能很好支持的模式。当然也可以解决这个限制，但是解决方案涉及到改造Airflow调度器持续重复解析DAG文件和动态响应DAG变量。如果你的业务需要利用调度程序的内部细节，你可能做错了。</p>
<p>Prefect为此类情况提供了方便的抽象。Prefect工作流的参数是一种特殊的task，它的值在运行期是可覆盖的。例如，我们在Prefect Cloud部署中运行时，可以通过简单的GraphQL调用或者Prefect的Python客户端来提供参数。</p>
<p>这提供了许多好处：</p>
<ul>
<li>当问题出现，数据的来龙去脉是透明的</li>
<li>你不需要为不同的参数输入创建新的工作流，只需要启动新的工作流执行。</li>
<li>允许设置响应事件的工作流，工作流可以根据不同的类型内容的事件来执行不同的分支</li>
</ul>
<p>早些时候，我们注意到Airflow甚至都没有同时运行一个工作流多个实例的概念。这有部分原因是Airflow工作流没有参数概念。当工作流无法响应输入，同时运行多个实例就没有意义。</p>
<p>但是，有了一等公民的参数化，我们就容易理解为什么我可能希望同时运行工作流的多个实例，例如发送多封电子邮件，或者更新多个数据源，或者任何其他系列活动等工作流逻辑相同和输入值可能不同的场景。</p>
<h2 id="动态化工作流"><a href="#动态化工作流" class="headerlink" title="动态化工作流"></a>动态化工作流</h2><blockquote>
<p>  你将需要更大的船。</p>
<p>  – 电影《大白鲨》</p>
</blockquote>
<p>除了参数化的工作流之外，经常遇到工作流内部有task的逻辑需要被重复运行几次的场景。假设task A需要从数据库查询所有的新客户列表。从这儿开始每一个客户ID都要交给另一个task做一些处理。在Airflow中，只有一个选择，实现一个下游task B，该task B接收客户ID列表，并循环一一处理。这种方式有以下缺点：</p>
<ul>
<li>UI操作界面无法体现task内部的循环造成的动态负载，执行过程难以监控</li>
<li>如果任何一条数据记录执行失败，则整个任务失败或者被丢弃形成黑洞</li>
<li>相应的，你要自己实现考虑规模和幂等逻辑，因为如果失败中途重试，系统很难理解哪些数据已经处理过，需要重试跳过。</li>
</ul>
<p>由于这是一种常见场景，因此Prefect将其专门抽象成我们称之为task mapping的功能。task mapping是指能够运行时根据上游task的输出结果来动态生成不同数量的下游task的能力。映射尤其强大，因为你可以在映射过的任务继续映射，从而轻松创建并行管道。归纳收集结果就像将映射的task作为输入输入到非映射任务一样简单。考虑一个简单例子，生成一个list，遍历每一个item两次做+1处理，然后计算liste的item之和。</p>
<p>工作流执行包括10个确认的的Prefect task，1个是list创建，4个是两次+1映射中的每一个，还有一个求和规约。任务映射提供许多好处：</p>
<ul>
<li>映射模式容易在工作流中表达</li>
<li>每一个task都是单独实例，意味着可以独立于其他单独重试告警</li>
<li>工作流的每一个执行都动态生成不同数量的task</li>
<li>作为一等公民功能，UI操作界面也能准确展示报告映射任务</li>
</ul>
<h2 id="多版本工作流"><a href="#多版本工作流" class="headerlink" title="多版本工作流"></a>多版本工作流</h2><blockquote>
<p>  为了通过编码解决工作问题，这还不够。</p>
<p>  – 《代码整洁之道》的作者[美]Robert C. Martin</p>
</blockquote>
<p>基于代码的系统的一个重要能力是能够对代码进行版本控制。</p>
<p>回想一下在Airflow里面，DAG是中枢调度器在检测指定的DAG目录包含的Python文件，并执行代码文件来发现DAG定义。这意味着，如果你更新给定的DAG，Airflow将会重新加载盲目执行，而并不会感知到代码的部分改变。如果你的DAG定义代码定期更新，这会引起一些麻烦。</p>
<ul>
<li>能够重新访问甚至运行旧的DAG的能力要求你存储旧的版本，并且还需要你在Airflow生态系统中抽象出单独的实体</li>
<li>UI操作界面对版本系统一无所知，也无法为多版本工作流提供有效的信息。</li>
</ul>
<p>在实践中，这意味着团队倾向使用GitHub控制版本，并将版本信息附加到文件名中。再者如果你的工作流代码变化缓慢，也不算负担。但是，由于数据工程日益成为快节奏的科学，包括实验和频繁更新，仅仅部署新的模型和参数，这种方式很快会失败。</p>
<p>在Prefect Cloud中，我们已经版本化的工作提升为一等公民。任何工作流都是版本集的一部分，以轻松追踪维护历史记录。与往常一样，我们有合理的默认值。</p>
<ul>
<li>当在一个项目部署一个同名工作流，版本系统会自动记录追踪</li>
<li>当一个工作流被版本化，会获得递增的版本号，并且对之前的老版本关闭自动调度和进行存档。</li>
</ul>
<p>如果你有更复杂的版本需求，这些都是有配置，可自定义的。例如，绕开项目和工作流名称规则，你可以直接指定某一个工作流是另外一个工作流的不同版本。你可以覆盖自动版本升级，来取消存档并启用旧版本（例如，用于A/B测试）。或者，你只是简单使用版本系统来维护工作流历史，而不会污染UI操作界面。</p>
<h2 id="本地测试"><a href="#本地测试" class="headerlink" title="本地测试"></a>本地测试</h2><blockquote>
<p>  可能出错的事物和不可能出错的事物之间最大的区别是，<br>  当不可能出错的事物出错时，<br>  通常发现根本无法修理。</p>
<p>  – 《Mostly Harmless》</p>
</blockquote>
<p>因为Airflow和Prefect都是用Python编写的，因此可以按照标准的Python模式来对独立的task逻辑进行单元测试。例如，在Airflow中，您可以导入DagBag提取单个DAG并对其结构或其中包含的任务进行各种声明。同样，在Prefect中，你可以轻松导入和检查工作流。此外，在Airflow和Prefect中，对于独立的task逻辑，都可以像其他Python代码一样进行单元测试。</p>
<p>然而，在Airflow中测试工作流要比Prefect复杂的多。这是由于多种原因：</p>
<ul>
<li>Airflow中的DAG级别执行是由中央调度器来控制协调的。这意味模拟数据来执行DAG需要初始化准备数据和调度服务。将其纳入CI持续集成流程中测试对很多人来说都是障碍。</li>
<li>Airflow的状态概念是用字符串描述的，这增加了测试数据传递的复杂性，或者引发什么类型异常，这需要数据库查询确定。</li>
</ul>
<p>另一方面，在Prefect中，工作流可以通过FlowRunner直接本地执行。此外，每个接口都提供了大量的额外参数，专门用于帮助测试流程，还贴心的包括一种手动指定上游task任意状态的方法。</p>
<p>例如，要确保触发器逻辑适用于单个任务，你能通过task_states关键字参数传递所有的上游任务状态，因为Prefect返回信息组合完整的状态对象（包括数据、异常和重试次数等信息），你可以轻松针对任务返回状态的性质做断言。</p>
<h2 id="UI操作界面"><a href="#UI操作界面" class="headerlink" title="UI操作界面"></a>UI操作界面</h2><blockquote>
<p>  我选择相信。</p>
<p>  – 电影《X档案》Fox Mulder</p>
</blockquote>
<p>Airflow最受欢迎的是他的web界面。在UI操作界面上，你可以轻松打开关闭DAG工作流，可视化DAG工作流执行进度，甚至可以对Airflow数据库进行查询。这是访问Airflow元数据的一种非常有用的方法。</p>
<p>这从设计Prefect的第一天开始，她就支持漂亮的实时的UI操作界面，Prefect并未参照Airflow那样直接裸露数据库数据模型，而是用最佳实践来回应用户使用过程最关心的问题：系统运行状况如何？并且如果出现问题，我如何快速定位？</p>
<p>Prefect UI操作界面支持如下：</p>
<ul>
<li>系统概况的仪表版</li>
<li>调度新的输入参数执行</li>
<li>实时更新task和对应的运行状态</li>
<li>人工干预更新状态</li>
<li>流式日志，包括立即跳转最新错误日志的能力</li>
<li>完整的交互式的GraphQL API接口</li>
<li>全局搜索</li>
<li>代理控制</li>
<li>组织工作流项目</li>
<li>团队管理和权限</li>
<li>API访问Token生成</li>
<li>密码管理</li>
<li>全局并发限制</li>
<li>时区（适合Airflow用户）</li>
<li>……还有很多</li>
</ul>
<p>UI操作界面是Prefect Cloud的一部分，它以能提供生产级工作流管理的基础结构来支持作为支持。但是我们致力于从开源产品的Cloud免费套餐开始，逐渐将完整地其提供给用户。我们正在研究将元素通过UI操作界面交付给开源用户的其他方式。</p>
<h2 id="Prefect的简单安装使用"><a href="#Prefect的简单安装使用" class="headerlink" title="Prefect的简单安装使用"></a>Prefect的简单安装使用</h2><p>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install prefect</span><br></pre></td></tr></table></figure>

<p>task编写</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> prefect <span class="keyword">import</span> task, Flow, Parameter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@task(log_stdout=True)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(name)</span>:</span></span><br><span class="line">    print(<span class="string">"Hello, &#123;&#125;!"</span>.format(name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> Flow(<span class="string">"My First Flow"</span>) <span class="keyword">as</span> flow:</span><br><span class="line">    name = Parameter(<span class="string">'name'</span>)</span><br><span class="line">    say_hello(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flow.run(name=<span class="string">'world'</span>) <span class="comment"># "Hello, world!"</span></span><br><span class="line">flow.run(name=<span class="string">'Marvin'</span>) <span class="comment"># "Hello, Marvin!"</span></span><br></pre></td></tr></table></figure>

<p>管理server启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prefect server start</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote>
<p>  如果我比其他人看的更远，是因为我站在巨人的肩上。</p>
<p>  – 艾萨克·牛顿</p>
</blockquote>
<p>Airflow普及了很多今天工程师认为理所当然的抽象概念和语义。不幸的是，随着数据科学工程的发展，它无法满足公司更多的动态需求。</p>
<p>Prefect是一种工具，它数以百计的工业用户那里收集了很多变化的需求。它是一个引擎，用于启用任意专有的工作流，从而提供适用各种数据应用程序的词汇表。</p>
<p>如果你想了解更多信息，请查看我们的文档或访问我们的<a href="https://github.com/PrefectHQ/prefect.git" target="_blank" rel="noopener">源码仓库</a>。如果你想试用Prefect Cloud，可以注册一个免费账号。</p>
<ul>
<li><a href="https://medium.com/the-prefect-blog/why-not-airflow-4cfa423299c4" target="_blank" rel="noopener">英版原文</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/complicated/">complicated</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/concurrently/">concurrently</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dynamic/">dynamic</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flexible/">flexible</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/off-schedule/">off-schedule</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/parametrized/">parametrized</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/backend-tool/">backend-tool</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-goplugin" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/08/04/goplugin/" class="article-date">
  	<time datetime="2018-08-04T00:44:55.000Z" itemprop="datePublished">2018-08-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/04/goplugin/">golang插件化方案</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h2><p>业务线的活动，每一次新活动都做独立项目开发，有大量重复代码，并且浪费数据服务的连接资源；排序服务也许要经常添加业务代码，目前是停服务发布……这些场景为了开发维护效率、稳定性、安全性和性能都使用了Go语言。Go是静态编译语言，在具体的动态场景该如何实现应用级别的持续交付呢？</p>
<p>基于k8s，nginx网关，队列回溯消费等工具的实现也可以实现不同程度的持续交付，但是持续交付的要求越高，搭建平台和维护的成本也越高。</p>
<p>从应用开发本身出发，可以考虑<strong>插件化</strong>。</p>
<h3 id="插件使用场景特点"><a href="#插件使用场景特点" class="headerlink" title="插件使用场景特点"></a>插件使用场景特点</h3><ol>
<li>可以热更新式扩展应用程序的功能列表</li>
<li>应对多变的业务需求，方便功能上下线</li>
<li>对于任意的go应用，能进行增量架构、代码分发以及代码上下线</li>
</ol>
<h3 id="插件设计标准"><a href="#插件设计标准" class="headerlink" title="插件设计标准"></a>插件设计标准</h3><ul>
<li>性能：调用插件要尽可能的快；对于任务插件，使用单独的工作空间（协程、线程、进程的池子化处理），大的、慢的、长期运行的插件，要少调用</li>
<li>稳定性：插件依赖的发布平台要少发布，交互API的设计要做好抽象，上下文的环境变量非必须不添加，减少升级需求，甚至能支持多个实例互备热升级</li>
<li>可靠性：如果有失效、崩溃的可能，必须有快速、简单、完整的恢复机制；业务插件的执行不能影响依赖的发布平台的守护进程或者线程的稳定</li>
<li>安全性：应该通过代码签名之类的手段防篡改</li>
<li>扩展性：支持插件热更新和上下线，下线需要健康检查，公共库插件至少能热加载</li>
<li>复用性：业务插件不要太多一次性的上下线</li>
<li>易用性：提供使用简单、功能正交的API，业务插件能够获取依赖的发布平台的上下文和调用公共库</li>
</ul>
<h2 id="2-Go的插件方式"><a href="#2-Go的插件方式" class="headerlink" title="2. Go的插件方式"></a>2. Go的插件方式</h2><h3 id="动态链接库plugin，官方文档"><a href="#动态链接库plugin，官方文档" class="headerlink" title="动态链接库plugin，官方文档"></a>动态链接库plugin，<a href="https://golang.org/pkg/plugin/" target="_blank" rel="noopener">官方文档</a></h3><p>语言本身支持，插件和主程序原生语法交互</p>
<ul>
<li>进程隔离：无，单进程</li>
<li>主程序调用插件：一切预协定object（包括function、channel）</li>
<li>插件感知主程序上下文：主程序预定义类型参数object（包括function、channel）</li>
<li>stream支持：单向，基于channel</li>
<li>插件发现：主程序循环扫描插件目录并维护状态；通过第三方文件diff工具维护，例如git</li>
<li>上线：能</li>
<li>下线：不能</li>
<li>更新：不能</li>
<li>通信：进程内</li>
<li>序列化：不需要</li>
<li>性能：高</li>
</ul>
<hr>
<p>Go plugin判断两个插件是否相同是通过比较pluginpath实现的，如果没有指定pluginpath，则由内部的算法生成, 生成的格式为plugin/unnamed-“ + root.Package.Internal.BuildID 。这种情况下，如果两个插件的文件名不同，引用包不同，或者引用的cgo不同，则会生成不同的插件，同时加载不会有问题。但是如果两个插件的文件名相同，相关的引用包也相同，则可能生成相同的插件，即使插件内包含的方法和变量不同，实现也不同。判断插件相同，热加载不会成功，也就意味着老插件不支持覆盖更新。</p>
<p>最好在编译的指定pluginpath，同时方便版本跟踪。目前生产环境建议一些公共库无服务依赖的函数，例如算法库之类的。</p>
<pre><code>go build -ldflags &quot;-pluginpath=plugin/hot-$(date +%s)&quot; -buildmode=plugin -o so/Eng.so eng/greeter.go </code></pre><h3 id="通信-序列化"><a href="#通信-序列化" class="headerlink" title="通信+序列化"></a>通信+序列化</h3><h4 id="natefinch-pie，github仓库"><a href="#natefinch-pie，github仓库" class="headerlink" title="natefinch/pie，github仓库"></a>natefinch/pie，<a href="https://github.com/natefinch/pie" target="_blank" rel="noopener">github仓库</a></h4><ul>
<li>进程隔离：有，多进程，provider+comsumer</li>
<li>主程序调用插件：provider模式调用插件进程中预协定method；consumer模式消费插件进程中的预协定参数object（包括function、除了channel）</li>
<li>插件感知主程序上下文：provider模式消费主程序的预定义参数object（包括function、除了channel）；consumer模式调用主程序中预定义method</li>
<li>stream支持：不支持</li>
<li>插件发现：主程序循环扫描插件目录并维护状态；通过第三方文件diff工具维护，例如git</li>
<li>上线：能</li>
<li>下线：能</li>
<li>更新：能</li>
<li>通信：支持stdin/stdout、pipe、unix socket、tcp、http、jsonrpc</li>
<li>序列化：gob，protobuf, json, xml</li>
<li>性能：中/偏高</li>
</ul>
<hr>
<p>基于Go的net/rpc库，无法支持主程序和插件之间的streaming数据交互，有golang的官方包[<a href="https://github.com/golang/go/issues/6569" target="_blank" rel="noopener">issue1</a>]和[<a href="https://github.com/golang/go/issues/14140" target="_blank" rel="noopener">issue2</a>]直接建议。另外，每一个插件都要开一个进程，因此要注意通信序列化的性能消耗和进程管理，默认使用stdin/stdout建立连接，如下图，一个plugin和主程序之间有两条单向连接。</p>
<p>可以上成产环境，要做好资源管理。</p>
<p><img src="/2018/08/04/goplugin/1529650772.png" alt="plugin"></p>
<h4 id="hashicorp-go-plugin，github仓库"><a href="#hashicorp-go-plugin，github仓库" class="headerlink" title="hashicorp/go-plugin，github仓库"></a>hashicorp/go-plugin，<a href="https://github.com/hashicorp/go-plugin" target="_blank" rel="noopener">github仓库</a></h4><ul>
<li>进程隔离：有，多进程，server+client</li>
<li>主程序调用插件：一切协议预协定object</li>
<li>插件感知主程序上下文：一切协议预协定object</li>
<li>stream支持：单向和双向，基于http/2</li>
<li>插件发现：主程序循环扫描插件目录并维护状态；通过第三方文件diff工具维护，例如git</li>
<li>上线：能</li>
<li>下线：能</li>
<li>更新：能</li>
<li>通信：支持grpc</li>
<li>序列化：protobuf</li>
<li>性能：中/偏高</li>
</ul>
<hr>
<p>基于Google的grpc库，按照微服务的流程定义proto文件，能通信就能互相调用。知名团队出品。可以上成产环境，要做好资源管理。</p>
<p><img src="/2018/08/04/goplugin/1529650927.png" alt="grpc"></p>
<h4 id="go-mangos-mangos，github仓库"><a href="#go-mangos-mangos，github仓库" class="headerlink" title="go-mangos/mangos，github仓库"></a>go-mangos/mangos，<a href="https://github.com/go-mangos/mangos" target="_blank" rel="noopener">github仓库</a></h4><ul>
<li>进程隔离：有，多进程，provider+comsumer</li>
<li>主程序调用插件：一切预协定object</li>
<li>插件感知主程序上下文：一切预协定object</li>
<li>stream支持：单向，基于mq</li>
<li>插件发现：主程序循环扫描插件目录并维护状态；通过第三方文件diff工具维护，例如git</li>
<li>上线：能</li>
<li>下线：能</li>
<li>更新：能</li>
<li>通信：支持mq</li>
<li>序列化：未知</li>
<li>性能：中/偏高</li>
</ul>
<hr>
<p>基于消息队列协议通信，nanomsg和ZeroMQ一类的规范包含一组预定义的通信拓扑（称为“可扩展性协议”），涵盖许多不同的场景：Pair，PubSub，Bus，Survey，Pipeline和ReqRep。Mangos是该协议的golang实现，能够灵活方便支地持两个插件交流。</p>
<p>可以上成产环境，要走大量的基础建设开发。</p>
<p><img src="/2018/08/04/goplugin/1529651104.png" alt="mq"></p>
<h3 id="嵌入式脚本语言"><a href="#嵌入式脚本语言" class="headerlink" title="嵌入式脚本语言"></a>嵌入式脚本语言</h3><p>一般都是进程内内嵌第三方语言的解释器，需要考虑解释器的工作线程资源的重复利用。</p>
<p><img src="/2018/08/04/goplugin/1529651501.png" alt="embedscript"></p>
<ul>
<li>进程隔离：无，单进程，解释器有goroutine开销</li>
<li>主程序调用插件：一切语言协定object</li>
<li>插件感知主程序上下文：一切语言协定object</li>
<li>stream支持：看语言是否支持channel互通</li>
<li>插件发现：主程序循环扫描插件目录并维护状态；通过第三方文件diff工具维护，例如git</li>
<li>上线：能</li>
<li>下线：能</li>
<li>更新：能</li>
<li>通信：无</li>
<li>序列化：无</li>
<li>性能：中</li>
</ul>
<h4 id="go-like脚本语言，agora和七牛qlang"><a href="#go-like脚本语言，agora和七牛qlang" class="headerlink" title="go-like脚本语言，agora和七牛qlang"></a>go-like脚本语言，<a href="https://github.com/mna/agora" target="_blank" rel="noopener">agora</a>和<a href="https://github.com/qiniu/qlang" target="_blank" rel="noopener">七牛qlang</a></h4><p>agora和qlang都是go语法的动态脚本语言，都好几年没维护了，建议不要用在生产环境，其中Qlang还有用户提[<a href="https://github.com/qiniu/qlang/issues/153" target="_blank" rel="noopener">issue</a>]觉得不稳定。</p>
<h4 id="其他脚本语言，js-otto、go-lua5-1、go-lua5-2"><a href="#其他脚本语言，js-otto、go-lua5-1、go-lua5-2" class="headerlink" title="其他脚本语言，js-otto、go-lua5.1、go-lua5.2"></a>其他脚本语言，<a href="https://github.com/robertkrimen/otto" target="_blank" rel="noopener">js-otto</a>、<a href="https://github.com/yuin/gopher-lua" target="_blank" rel="noopener">go-lua5.1</a>、<a href="https://github.com/yuin/https://github.com/Shopify/go-lua" target="_blank" rel="noopener">go-lua5.2</a></h4><p>otta支持目前受欢迎的js语法，star比较多，协定了大部分go原生支持的类型，不包括channel和goroutine，没有提供解释器的工作空间池子化管理，需要开发者使用goroutine和解释器的interrupt接口自行实现，但是从issue和TODO来看，也不适合生产环境。</p>
<p>gopher-lua支持lua5.1语法，和go交互的object类型比较完备，协定了大部分go原生支持的类型，包括channel和goroutine，有提供解释器的工作空间池子化管理，可以上生产环境。</p>
<p>go-lua支持lua5.2语法，目前不建议上生产环境。</p>
<h2 id="3-思考"><a href="#3-思考" class="headerlink" title="3. 思考"></a>3. 思考</h2><ol>
<li>主程序需要怎样设计才能给业务插件预定义完美的上下文呢？例如线程池、redis连接池、mysql连接池、rocketmq、外部服务依赖等等</li>
<li>公共库插件和业务插件是否适合不同的插件方式？公共库插件方便为业务插件增加提供上下文吗？</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mq通信/">mq通信</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rpc通信/">rpc通信</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/嵌入式脚本/">嵌入式脚本</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/热加载/">热加载</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/go/">go</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-sum2017" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/12/31/sum2017/" class="article-date">
  	<time datetime="2017-12-31T07:53:37.000Z" itemprop="datePublished">2017-12-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/31/sum2017/">人生半坡 想上就努力上</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <style>
    p{text-indent: 2em;}
    img[title="three"] {width: 95%;}
</style>

<p>忽然朋友圈刷满了那些年，18岁的天空，很蓝，云朵，很闲。我知道2017的最后一天，大家在虚拟的空间里集合，是要也是该缅怀点什么了，所以一批人生半坡的中年男在朋友圈里回到了18岁，其中一个就是我，但是我已经不认识18的他们了，甚至不认识18岁的自己。</p>
<p>一恍惚，18岁过去了，大学毕业已经5年了。再回头看看，我只有2013年毕业写过一篇一周年总结<a href="http://834945712.iteye.com/admin/blogs/1915873" target="_blank" rel="noopener">2013一周年总结</a>，4年“嗖”的一下就过去了。</p>
<p>2014年，我在一家做酒店在线旅游的公司上班，叫快捷酒店管家，那是我呆的第一家创业公司，十几个小伙伴让我觉得很新鲜，leader也很提携后生，在这里有很多事做，我一直忙着写业务，才发现自己的技术基础很薄弱，就算看了很多文章，做具体东西时，还是有点茫然，加上学习贪多又没有形成舒适的节奏，其实做的蛮辛苦，但是当时团队有很多牛逼的资源，所以我还是想留下努力继续试试。无奈后来因为工作环境和人事调整各种原因，我还是选择了离开。啊，这里还有一段失败的不能称之为恋情的感情，还有，这里的同事都是生活的高手，叫我理财，帮我找女朋友，挺有意思的，反而，我觉得我是个没意思的人，而且对生活常识有点失去了信心。这里一方面因为个人的素质偏差，一方面因为工作环境的变化，导致我应该及早抽身离开，却贪恋一些东西而没有及早离开，是一种小遗憾。我在很多时候，还是会怀念一下那一段不一样的日子。</p>
<p>2015年，我离开了颇为眷恋又不想呆的第一家创业公司，在同学ZYQ和XJQ配合准备下，来到了北京，又是一家小的创业公司，叫光点图灵，人不多，不过我已经没有了当年初进创业公司的新鲜感了，同事也都很好，老板一张娃娃脸，人也很nice，最爽的是酒喝得少了。平时我就忙着做事，而且我跟俩同学是有自己的小的创业计划的，虽然最后没成，那又怎样，我们付出了。在和同学的创业过程中，我发现自己的节奏也不是很好，原因还是整体素质和心态不到位。</p>
<p>2016年，我离开了前一家创业公司，因为这家创业公司搬到武汉去了，不过就算不搬，我也要离开了。我选了一家叫赤子城的做海外直播的公司，去之前，拿过果壳和小米的offer，但是这里给很多期权，薪水也不少，我也在一些统计数据网站调查了，公司的数据不错，都D轮了。来干了一年半载，只能说有我喜欢的，也有我不喜欢的地方，而且我现在的想法是做好工作，拿到想要的待遇，没有其他任何想法。</p>
<p>然而2017年底，因为种种原因，我又离开了，我离开了北京，回到武汉斗鱼，有时候默默念叨着“Don’t cry for me, Beijing, I will be back, maybe in a winter.”算是勉励自己吧。在武汉也挺好的，今晚我见到了小时候一起在河里摸鱼儿的玩伴，他也是个成熟稳重的小伙子了，感觉很温暖。</p>
<p>这几年的工作，我还是在逐步上升，越来越相信自己了，总结在以下几点：</p>
<blockquote>
<p><strong>产品素质提升</strong>，曾经工作的时候，同事们聊业务我很被动，现在我能主导控制了。之所以有这种变化，是因为第一份工作的leader灌输了很多提高产品嗅觉的方法论，不知不觉用上了；而且俩同学的产品素质都很好，经常聊，慢慢长进了；还有一个重要原因是，生活消费慢慢打开买买买，会让人了解主动分析更多的生活逻辑，这是产品逻辑的根本来源。</p>
</blockquote>
<blockquote>
<p><strong>专业技能提升</strong>，这个我觉得，一方面是很多以前不太注意的基础理论，例如操作系统、数据库、网络原理、算法数据结构、分布式，都在恶补，一遍看不懂，再看一遍，再看不懂，看三遍…..直到有自己的理解为止，理论懂的多了，更容易把握项目整体，而且能控制变化；另一方面经历的项目变多变丰富，做事情效率提高很多，也就有更多时间去思考和学习。</p>
</blockquote>
<blockquote>
<p><strong>生活能力提升</strong>，还是要提的，毕竟自己是一个山里娃，曾经不敢消费，节约的观念和家境的忧虑根深蒂固，导致做事畏首畏尾，自己也过得不舒坦，别人也不乐意交往。压抑一些正常的消费行为，也让人对社会生活缺少信心，总之状态差，精神面貌也不好。现在随着朋友和同学的消费理财引导下，我也开始建立正常的消费观念，让生活舒适一些，这一点，很感激他们，虽然现在还没达到理想状态，但是在不断变好。</p>
</blockquote>
<p>虽然生活工作爱情还没有满意，而人生已经半坡，但是我一定会握紧泡满枸杞的保温杯，想上就努力上。</p>
<p>具体的执行包括以下几点：</p>
<ul>
<li><p>创业，是我永远不会停下的想法，就算最后创业不成功。技术创业，俩同学是我最好的搭档；如果是农业养殖的话，不知道找谁好；如果是搞文化，也有很适合的同学…..总之，不愿做工作的人们，前进，前进，进</p>
</li>
<li><p>产品素质，通过多观察生活，理解人生，使用各种新技术产品，和不同的人多聊聊，来提升自己的产品理解能力和构建能力</p>
</li>
<li><p>专业技能，一是要通过看技术文章和书籍巩固基础理论知识，多动手写代码实践理解；二是要抓热点，吸纳新的知识，紧跟潮流，把控未来</p>
</li>
<li><p>生活能力，多找朋友聊天，多找姑娘聊天，多找亲人聊天，强力刷出自己的存在感，早点定个姑娘，安顿生活</p>
</li>
<li><p>我的文字爱好，照常继续</p>
</li>
<li><p>该做减法了，不擅长或者不喜欢的东西不碰了，要时常自我反省，自娱自乐</p>
</li>
</ul>
<p>我觉得和同学技术创业三人组很像海贼王里的一些角色，哈哈哈。<br><img src="/2017/12/31/sum2017/three.jpg" alt="three"></p>
<p>今天是28岁的最后一天，我只想过好28岁，18岁的一切，记得就记得，忘了就忘了，没有啥好强求的，毕竟脑容量有限，遗忘、辞旧才能迎新，至于记得的那部分就是一部分你。</p>
<p>29岁，我告诉你，我不是一个油腻的中年男，也不是一个成功的中年男，但我是一个努力的男人。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/上/">上</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/人生半坡/">人生半坡</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/减法/">减法</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/努力/">努力</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/自省自乐/">自省自乐</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/sum/">sum</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-goc" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/27/goc/" class="article-date">
  	<time datetime="2017-11-27T11:40:17.000Z" itemprop="datePublished">2017-11-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/27/goc/">go的context</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <style>
    img[title="ctx"] {width: 80%;}
</style>
<h2 id="context"><a href="#context" class="headerlink" title="context"></a>context</h2><p>包(context)类型是包装了channel通信来关联goroutine服务之间的控制机制，支持树状的上级控制一个或者多个下级，不支持反向控制和平级控制，同理参数的共享是树状的传递流动方向，也可以用来管理有超时依赖的函数，以下代码实例里面，存在forever for循环的才算服务。</p>
<blockquote>
<p>参数共享特性</p>
</blockquote>
<ul>
<li>context的参数存储不是map，是struct的key和val两个属性，对外暴露操作接口</li>
<li>context的参数由父goroutine初始化，子goroutine调用</li>
<li>父context会嵌入子context，同名参数相当于有多个版本</li>
<li>子context获取参数会按照embed的向上查找机制获得多层父级context的参数，同名参数优先使用子context的参数版本</li>
<li>子context初始化非同名参数，相当于增加新参数</li>
<li>子context初始化同名参数，相当于增加一个参数版本</li>
<li>context传递的参数注意选择必要的，简单的，size小的</li>
<li>context因为只读所以是gorountine安全的，可以多个子gorountine服务共享同一个context的父控制</li>
</ul>
<blockquote>
<p>控制特性</p>
</blockquote>
<ul>
<li>父gorountine服务通过context控制子gorountine服务，由struct里面的空channel实现，父gorountine服务close空channel，子gorountine服务的select监听并可能触发关闭事件，结束生命周期</li>
<li>父gorountine服务达到某种状态，传递信号，结束子gorountine服务</li>
<li>父gorountine服务初始化启动子gorountine服务时，传入截止时刻或者超时时间</li>
<li>父gorountine结束，则所有的子gorountine服务结束</li>
<li>以上三条规则共同决定一个gorountine服务的生命周期</li>
</ul>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> &#123;</span><br><span class="line">    Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; <span class="comment">//控制生命周期的空channel</span></span><br><span class="line">    Err() error <span class="comment">//获取错误码</span></span><br><span class="line">    Deadline() (deadline time.Time, ok <span class="keyword">bool</span>) <span class="comment">//获取截止时间</span></span><br><span class="line">    Value(key <span class="keyword">interface</span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125; <span class="comment">//传递参数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>子goroutine服务的关联的context是通过WithCancel, WithDeadline, WithTimeout, WithValue复制父goroutine服务的内容，派生出新的context。CancelFunc可以取消所有的后代，移除父goroutine服务在子goroutine服务的关联，并停止所有关联timer。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"context"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tree</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx1 := context.Background()</span><br><span class="line">    ctx2, _ := context.WithCancel(ctx1)</span><br><span class="line">    ctx3, _ := context.WithTimeout(ctx2, time.Second * <span class="number">5</span>)</span><br><span class="line">    ctx4, _ := context.WithTimeout(ctx3, time.Second * <span class="number">3</span>)</span><br><span class="line">    ctx5, _ := context.WithTimeout(ctx3, time.Second * <span class="number">6</span>)</span><br><span class="line">    ctx6 := context.WithValue(ctx5, <span class="string">"userID"</span>, <span class="number">12</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码的Context链下图：<br><img src="/2017/11/27/goc/context_1.svg" alt="ctx"><br>3秒超时：ctx4超时退出<br><img src="/2017/11/27/goc/context_2.svg" alt="ctx"><br>5秒超时：ctx3超时退出，导致子节点ctx5和ctx6都退出<br><img src="/2017/11/27/goc/context_3.svg" alt="ctx"><br>这里只是形象的表示了多级context之间形成的控制关系，实际业务里面ctx5,ctx6所在的goroutine如果在执行业务是不会立即退出的，只有当goroutine在等待IO事件等待数据的时候才会由select响应结束的case。</p>
<p>** Background和TODO **<br>都是返回一样的无控制条件无参数的empty Context，background在主服务里面通常作为匿名参数生成可控的context变量；todo可能会用于程序兼容处理，当空桩，做空调用</p>
<p>** WithCancel **<br>传入父Context，返回可控子Context，并且返回结束调用子context的goroutine的控制函数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//func WithCancel(parent Context) (ctx Context, cancel CancelFunc)</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"context"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    gen := <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span> &lt;-<span class="title">chan</span> <span class="title">int</span></span> &#123;</span><br><span class="line">        dst := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">        n := <span class="number">1</span></span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="keyword">for</span> &#123; <span class="comment">//for循环是goroutine 函数作为服务的标志</span></span><br><span class="line">                <span class="keyword">select</span> &#123;</span><br><span class="line">                <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                <span class="keyword">case</span> dst &lt;- n: <span class="comment">//这里堵塞有可能会成为函数的超时依赖</span></span><br><span class="line">                    n++</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;()</span><br><span class="line">        <span class="keyword">return</span> dst</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">    <span class="keyword">defer</span> cancel() <span class="comment">//一定要手动加取消操作</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> n := <span class="keyword">range</span> gen(ctx) &#123;</span><br><span class="line">        <span class="built_in">println</span>(n)</span><br><span class="line">        <span class="keyword">if</span> n == <span class="number">5</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>** WithDeadline **<br>传入父Context和截止期限，返回包含截止期限的可控子Context，并且返回结束调用子context的goroutine的控制函数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//func WithDeadline(parent Context, deadline time.Time) (Context, CancelFunc)</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"context"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    d := time.Now().Add(<span class="number">50</span> * time.Millisecond)</span><br><span class="line">    ctx, cancel := context.WithDeadline(context.Background(), d)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(<span class="number">1</span> * time.Second):</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"overslept"</span>)</span><br><span class="line">    <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">        <span class="built_in">println</span>(ctx.Err())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>** WithTimeout **<br>传入父Context和超时时间，返回包含超时时间的可控子Context，并且返回结束调用子context的goroutine的控制函数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc)</span></span><br></pre></td></tr></table></figure>

<p>** WithValue **<br>传入父Context和参数key-val，返回包含参数的子Context，如果父context是background，那么子context不可控，否则可控</p>
<ul>
<li>在服务里面context.Background()，不适合作为有变量接收的WithValue的参数，可以是ctx := context.WithCancel(context.WithValue(context.Background(), k, “Go”))</li>
<li>context的key是包内的全局变量，不可导出，避免冲突</li>
<li>context的key的数据类型必须支持==和!=，类似于map的key，包括bool,number,string,pointer,channel,interface和包含上述类型的array,struct。不支持slice,map,function或者包含它们的类型。</li>
<li>存储的数据最好是type-safe</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//func WithValue(parent Context, key, val interface&#123;&#125;) Context</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"context"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">type</span> favContextKey <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">    f := <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, k favContextKey)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> v := ctx.Value(k); v != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">println</span>(<span class="string">"found value:"</span>, v)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"key not found:"</span>, k)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    k := favContextKey(<span class="string">"language"</span>)</span><br><span class="line">    ctx := context.WithValue(context.Background(), k, <span class="string">"Go"</span>)</span><br><span class="line"></span><br><span class="line">    f(ctx, k)</span><br><span class="line">    f(ctx, favContextKey(<span class="string">"color"</span>))</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>go vet tool可以检查CancelFuncs的使用情况。context参数不要包裹在struct等一些复杂的数据结构里面，context参数位置放在函数的第一个变量，context参数不要传递nil。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><blockquote>
<p>如何实现平级控制，一个子goroutine出现问题同时取消共享父控制的其他子goroutine，<strong>参见</strong><a href="https://godoc.org/golang.org/x/sync/errgroup" target="_blank" rel="noopener">golang.org/x/sync/errgroup
</a></p>
</blockquote>
<blockquote>
<p>To avoid allocating when assigning to an interface{}, context keys often have concrete type struct{}. Alternatively, exported context key variables’ static type should be a pointer or interface. <strong>这是什么意思？</strong></p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/context/">context</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/goroutine/">goroutine</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/go/">go</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-pilosa1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/12/pilosa1/" class="article-date">
  	<time datetime="2017-06-12T01:44:55.000Z" itemprop="datePublished">2017-06-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/12/pilosa1/">pilosa分布式位图数据库（1）</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Pilosa"><a href="#Pilosa" class="headerlink" title="Pilosa"></a>Pilosa</h2><ul>
<li>能够轻松横向扩展，并且保证速度的位图数据库，支持数据版本的粗粒度的时间序列（最小粒度到小时）</li>
<li>适合高频次的流数据处理，使用场景例如，如果你的业务主体数据达到10亿量级，并且该数据的附加属性数量达到百万级别，当你需要实时的筛选符合各种属性组合条件的业务主体数据，Pilosa会是个好帮手</li>
<li>Pilosa的数据存储不像现有的关系型数据mysql、oracle的行式存储（一行是一个业务实体，一列是同一种数据实体同一个属性），包括index，column、frame、row、cell，是列式存储</li>
<li>一个index类似一张表，数据查询不能跨index</li>
<li>一个column表示一个业务实体，有业务意义，包括多个frame一行row的组合，从平面形象上看是纵向的</li>
<li>一个frame，表示一个业务实体的属性，有业务意义，是row的集合，从平面形象上看是横向的</li>
<li>一个row表示一个属性的一行数据存储，是cell的集合，从平面形象上看是横向的</li>
<li>一个cell就是0/1，是数据存储的逻辑最小单元</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><strong>MacOS</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(workspace) ➜  brew install pilosa</span><br></pre></td></tr></table></figure>

<p><strong>二进制包</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(workspace) ➜  curl -L -O https://github.com/pilosa/pilosa/releases/download/v0.4.0/pilosa-v0.4.0-darwin-amd64.tar.gz</span><br><span class="line">(workspace) ➜  tar xfz pilosa-v0.4.0-darwin-amd64.tar.gz</span><br><span class="line">(workspace) ➜  cp -i pilosa-v0.4.0-darwin-amd64/pilosa /usr/<span class="built_in">local</span>/bin</span><br></pre></td></tr></table></figure>

<p><strong>go源码</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(workspace) ➜  go get -d github.com/pilosa/pilosa</span><br><span class="line">(workspace) ➜  <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/pilosa/pilosa</span><br><span class="line">(workspace) ➜  make install</span><br></pre></td></tr></table></figure>

<p><strong>docker</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(workspace) ➜  docker pull pilosa/pilosa:latest</span><br><span class="line">(workspace) ➜  docker run --rm pilosa/pilosa:latest <span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p><strong>业务场景</strong></p>
<p>Star Trace是一个跟踪github开源项目的关注情况的业务，有1000条最近有更新并且名称包含go的项目数据，数据字段包括编程语言，标签，项目的关注者。</p>
<p><strong>启server</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(workspace) ➜  pilosa --<span class="built_in">help</span></span><br><span class="line">(workspace) ➜  pilosa server</span><br></pre></td></tr></table></figure>

<p><strong>client操作</strong></p>
<ul>
<li>建表，column是repository，frame是stargazer和language，构成了业务</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(workspace) ➜  curl localhost:10101/status</span><br><span class="line">(workspace) ➜  curl localhost:10101/schema</span><br><span class="line">(workspace) ➜  curl localhost:10101/index/repository \</span><br><span class="line">     -X POST \</span><br><span class="line">     -d <span class="string">'&#123;"options": &#123;"columnLabel": "repo_id"&#125;&#125;'</span></span><br><span class="line">(workspace) ➜  curl localhost:10101/index/repository/frame/stargazer \</span><br><span class="line">     -X POST \</span><br><span class="line">     -d <span class="string">'&#123;"options": &#123;"rowLabel": "stargazer_id", </span></span><br><span class="line"><span class="string">                      "timeQuantum": "YMD",</span></span><br><span class="line"><span class="string">                      "inverseEnabled": true&#125;&#125;'</span></span><br><span class="line">(workspace) ➜  curl localhost:10101/index/repository/frame/language \</span><br><span class="line">     -X POST \</span><br><span class="line">     -d <span class="string">'&#123;"options": &#123;"rowLabel": "language_id",</span></span><br><span class="line"><span class="string">                      "inverseEnabled": true&#125;&#125;'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>数据导入</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(workspace) ➜  curl -O https://raw.githubusercontent.com/pilosa/getting-started/master/stargazer.csv</span><br><span class="line">(workspace) ➜  curl -O https://raw.githubusercontent.com/pilosa/getting-started/master/language.csv</span><br><span class="line">(workspace) ➜  pilosa import -i repository -f stargazer stargazer.csv</span><br><span class="line">(workspace) ➜  pilosa import -i repository -f language language.csv</span><br></pre></td></tr></table></figure>

<ul>
<li>查询操作，查询的结果都是列id</li>
</ul>
<p>查14号用户关注的repository</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(workspace) ➜  curl localhost:10101/index/repository/query \</span><br><span class="line">     -X POST \</span><br><span class="line">     -d <span class="string">'Bitmap(frame="stargazer", stargazer_id=14)'</span></span><br></pre></td></tr></table></figure>

<p>查编程语言是5的repository</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(workspace) ➜  curl localhost:10101/index/repository/query \</span><br><span class="line">     -X POST \</span><br><span class="line">     -d <span class="string">'TopN(frame="language", n=5)'</span></span><br></pre></td></tr></table></figure>

<p>查14号用户和19号用户的关注的repository交集</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(workspace) ➜  curl localhost:10101/index/repository/query \</span><br><span class="line">     -X POST \</span><br><span class="line">     -d <span class="string">'Intersect(Bitmap(frame="stargazer", stargazer_id=14), Bitmap(frame="stargazer", stargazer_id=19))'</span></span><br></pre></td></tr></table></figure>

<p>查14号用户和19号用户的关注的repository并集</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(workspace) ➜  curl localhost:10101/index/repository/query \</span><br><span class="line">     -X POST \</span><br><span class="line">     -d <span class="string">'Union(Bitmap(frame="stargazer", stargazer_id=14), Bitmap(frame="stargazer", stargazer_id=19))'</span></span><br></pre></td></tr></table></figure>

<p>查14号用户和19号用户的共同关注的并且语言是1的repository</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(workspace) ➜  curl localhost:10101/index/repository/query \</span><br><span class="line">     -X POST \</span><br><span class="line">     -d <span class="string">'Intersect(Bitmap(frame="stargazer", stargazer_id=14), Bitmap(frame="stargazer", stargazer_id=19), Bitmap(frame="language", language_id=1))'</span></span><br></pre></td></tr></table></figure>

<p>在frame为stargazer里面，加一行关注者为99999数据，列上repository为77777的cell为1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(workspace) ➜  curl localhost:10101/index/repository/query \</span><br><span class="line">     -X POST \</span><br><span class="line">     -d <span class="string">'SetBit(frame="stargazer", repo_id=77777, stargazer_id=99999)'</span></span><br></pre></td></tr></table></figure>

<p>经过基本的使用，我觉得pilosa比传统的关系型数据库更侧重于关系，而通过列式存储的架构，方便了大数据的实时聚合计算，所以pilosa是为了在某些场景替代传统关系型数据库，对于文档数据库mongo和嵌入式数据库没有影响。在一些业务庞大的公司里面应该是可以考虑引入的。如果要继续了解pilosa，请阅读<a href="http://kuanshijiao.com/2017/06/12/pilosa2/" target="_blank" rel="noopener">pilosa分布式位图数据库（2）</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bitmap/">bitmap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/distributed/">distributed</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/index/">index</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/数据库/">数据库</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-pilosa2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/12/pilosa2/" class="article-date">
  	<time datetime="2017-06-12T01:44:55.000Z" itemprop="datePublished">2017-06-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/12/pilosa2/">pilosa分布式位图数据库（2）</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <style>
    p{text-indent: 2em;}
    img[title="pilosa"] {width: 75%;}
</style>

<h2 id="几种数据结构"><a href="#几种数据结构" class="headerlink" title="几种数据结构"></a>几种数据结构</h2><p>Pilosa的元逻辑存储结构是一个bool矩阵，每一个cell的0/1表示行列是否存在关系。行和列可以表示任何东西，甚至可以表示相同的事物（这一点对基于pilosa思维优化查询和存储非常重要）。</p>
<p>基本的逻辑数据结构决定了业务的架构和封装模式。Pilosa的数据结构比文档数据库和传统关系数据库都多，是否能满足各种业务设计呢？是否满足就适合用呢？</p>
<h4 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h4><p>类似于mysql的table，mongo的collection，表示一个业务数据的命名空间，无法对两个以上的index做联合查询。</p>
<h4 id="Column"><a href="#Column" class="headerlink" title="Column"></a>Column</h4><p>column用ID表示，是顺序递增的整数，并且要赋予业务意义，是同一个index下面的所有frame共用，在index的作用域里是唯一的。</p>
<h4 id="Row"><a href="#Row" class="headerlink" title="Row"></a>Row</h4><p>row用ID表示，是顺序递增的整数，并且要赋予业务意义，在frame的作用域里是唯一的。</p>
<h4 id="Frame"><a href="#Frame" class="headerlink" title="Frame"></a>Frame</h4><p><img src="/2017/06/12/pilosa2/pilosa1.png" alt="pilosa"><br>frame其实是对应传统关系型数据库中的每一列的属性，是pilosa的row的高维结构，由多row组成，从平面形象上看，将数据表格上多行row的整体看做一个frame，这样划分可以对0/1的二元表示意义进行扩展，满足业务多状态的需求</p>
<ul>
<li><p>ranked cache of a frame<br><img src="/2017/06/12/pilosa2/pilosa2.png" alt="pilosa"><br>有序frame是通过行ID维护列计数的高速缓存，该缓存便于TopN查询，缓存大小默认为50,000</p>
</li>
<li><p>LRU cache of a frame<br><img src="/2017/06/12/pilosa2/pilosa3.png" alt="pilosa"><br>LRU缓存维护frame最近访问的行</p>
</li>
</ul>
<h4 id="Slice-与分布式有关"><a href="#Slice-与分布式有关" class="headerlink" title="Slice 与分布式有关"></a>Slice 与分布式有关</h4><p>切片是列组，是pilosa的column的高维结构，包含多个column，每个切片包含固定数量的列，有SliceWidth。和column的关系，从平面形象上看类似于frame和row的关系，但是frame是有业务意义的，slice是为了分布式设计，通过预设宽度划分column成切片，用一致性哈希算法将切片分布到各cluster</p>
<h4 id="Attribute"><a href="#Attribute" class="headerlink" title="Attribute"></a>Attribute</h4><p>在传统关系数据库里面关系表的数据，分为两种，一种是纯粹的关系，只存储ID，通过增删或者update status来表示关系的状态；另外一种关系同时已经是一种新的业务实体了，除了ID关系，还有业务属性。<br>第二种情况的附加业务属性就需要Attribute来支撑。</p>
<h4 id="Time-Quantums"><a href="#Time-Quantums" class="headerlink" title="Time Quantums"></a>Time Quantums</h4><p>time quantums在frame上设置支持时间序列，会产生额外的数据冗余，这允许范围查询缩小到指定的时间间隔。 例如 - 如果时间量被设置为YMD，则支持范围查询到一天的粒度。</p>
<p>如果帧具有时间量化，则为每个定义的时间段生成视图。 例如，对于时间量级为YMD的帧，以下SetBit（）查询将导致下图中描述的数据：</p>
<h4 id="View"><a href="#View" class="headerlink" title="View"></a>View</h4><p>视图表示frame的数据物理布局存在的可能情况</p>
<ul>
<li>Standard view of frame</li>
</ul>
<p>标准视图的行列是输入的行列对应的，也是index中一定存在的一个布局</p>
<ul>
<li><p>Inverse view of frame<br><img src="/2017/06/12/pilosa2/pilosa4.png" alt="pilosa"><br>反向视图的行列是输入的行列颠倒的，即输入的行对应frame的列，输入的列对应frame的行，是index中可选的一个布局，会和标准视图及其他视图并存，在行列的业务意义是相同的时候，比较有意义，例如行列都是user_id</p>
</li>
<li><p>Time Quantums of frame<br><img src="/2017/06/12/pilosa2/pilosa5.png" alt="pilosa"><br>时间序列数据产生的多个布局，时间单位最小到小时，小时的布局包括年、月、日、时四个布局</p>
</li>
</ul>
<h2 id="几种业务案例"><a href="#几种业务案例" class="headerlink" title="几种业务案例"></a>几种业务案例</h2><p>（未完待续……）</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LRU-cache/">LRU cache</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Slice分布式/">Slice分布式</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Time-Quantum/">Time Quantum</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cell/">cell</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/column/">column</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/datamodel/">datamodel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/frame/">frame</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/index/">index</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/row/">row</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/数据库/">数据库</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-gotest3" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/21/gotest3/" class="article-date">
  	<time datetime="2017-04-21T04:21:48.000Z" itemprop="datePublished">2017-04-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/21/gotest3/">go 无数据抽象设计</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>interface是golang的抽象设计的根基，是方法集合的接口，是一个非常强大的并且规范的指针，可以引用任意实现了该接口的方法集合的struct，不能定义属性，意味着在抽象设计里是不允许有数据的，使语言的编译运行管理更纯粹方便。</p>
<h2 id="一切属性都是setter-getter"><a href="#一切属性都是setter-getter" class="headerlink" title="一切属性都是setter/getter"></a>一切属性都是setter/getter</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Surface <span class="keyword">struct</span>&#123;</span><br><span class="line">    skin <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Surface)</span> <span class="title">Skin</span><span class="params">()</span> <span class="title">string</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"My skin is "</span> + s.skin</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Men <span class="keyword">interface</span> &#123;</span><br><span class="line">    GetSurface() Surface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> European <span class="keyword">struct</span> &#123;</span><br><span class="line">    surface Surface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *European)</span> <span class="title">GetSurface</span><span class="params">()</span> <span class="title">Surface</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> p.surface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> African <span class="keyword">struct</span> &#123;</span><br><span class="line">    surface Surface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *African)</span> <span class="title">GetSurface</span><span class="params">()</span> <span class="title">Surface</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> p.surface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Introduce</span><span class="params">(men Men)</span></span>&#123;</span><br><span class="line">    s := men.GetSurface()</span><br><span class="line">    <span class="built_in">println</span>(s.Skin())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> s Surface</span><br><span class="line">    s = Surface&#123;<span class="string">"white"</span>&#125;</span><br><span class="line">    e := European&#123;s&#125;</span><br><span class="line">    Introduce(&amp;e)</span><br><span class="line">    s = Surface&#123;<span class="string">"black"</span>&#125;</span><br><span class="line">    a := African&#123;s&#125;</span><br><span class="line">    Introduce(&amp;a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上例中的多态，通过setter/getter变相完成了property在interface定义，用方法多态来实现属性多态。</p>
<h2 id="父类方法A调用子类方法B"><a href="#父类方法A调用子类方法B" class="headerlink" title="父类方法A调用子类方法B"></a>父类方法A调用子类方法B</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Men <span class="keyword">interface</span> &#123;</span><br><span class="line">    Age() <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Parent <span class="keyword">struct</span> &#123;</span><br><span class="line">    Men <span class="comment">//隐式</span></span><br><span class="line">    m Men <span class="comment">//显式</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parent)</span> <span class="title">Age</span><span class="params">()</span> <span class="title">int</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">80</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parent)</span> <span class="title">Display1</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">println</span>(p.Men.Age())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parent)</span> <span class="title">Display2</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">println</span>(p.m.Age())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Child <span class="keyword">struct</span> &#123;</span><br><span class="line">    Parent</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Child)</span> <span class="title">Age</span><span class="params">()</span> <span class="title">int</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">40</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> child *Child</span><br><span class="line">    <span class="keyword">var</span> parent *Parent</span><br><span class="line"></span><br><span class="line">    parent = &amp;Parent&#123;parent, <span class="literal">nil</span>&#125;</span><br><span class="line">    child = &amp;Child&#123;Parent: *parent&#125;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"====parent"</span>)</span><br><span class="line">    child.Display1()</span><br><span class="line"></span><br><span class="line">    parent = &amp;Parent&#123;child, <span class="literal">nil</span>&#125;</span><br><span class="line">    child = &amp;Child&#123;Parent: *parent&#125;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"====child"</span>)</span><br><span class="line">    child.Display1()</span><br><span class="line"></span><br><span class="line">    child.m = parent</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"====parent"</span>)</span><br><span class="line">    child.Display2()</span><br><span class="line"></span><br><span class="line">    child.m = child</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"====child"</span>)</span><br><span class="line">    child.Display2()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上例中的实现了在父类的A方法中调用父类或者子类的B方法，类似于抽象方法。因为go是静态语言，没有动态语言强大的查找机制，也没有虚函数(virtural method)和抽象方法(abstract method)之类的辅助高级别的多态。</p>
<p>幸好，golang有指针，即interface，又名接口，通过在父类定义接口类型的属性，并在实例化的时候动态绑定该属性的真正类型，来完成父类方法中一些多态方法的灵活调用，增加了公共部分的复用性。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/interface/">interface</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pointer/">pointer</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/property/">property</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/setter-getter/">setter/getter</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/父类方法调用子类方法/">父类方法调用子类方法</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/go/">go</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-bayes1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/13/bayes1/" class="article-date">
  	<time datetime="2017-03-13T05:57:34.000Z" itemprop="datePublished">2017-03-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/13/bayes1/">贝叶斯断癌</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>人患癌症的概率为1/1000.假设有一台癌症诊断仪S1，通过对它以往的诊断记录的分析，如果患者确实患有癌症它的确诊率为90%,如果患者没有癌症，被诊断成癌症的概率是10%。某人在被诊断为癌症后，他真正患癌症的概率为__</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/先验概率/">先验概率</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/全概率/">全概率</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后验概率/">后验概率</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/条件概率/">条件概率</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/theory/">theory</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-airflow1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/07/airflow1/" class="article-date">
  	<time datetime="2017-03-07T04:44:13.000Z" itemprop="datePublished">2017-03-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/07/airflow1/">Airflow的基本搭建</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>airflow是一个基于celery任务DAG管理工具，包括</p>
<ul>
<li>manage system</li>
<li>worker</li>
<li>scheduler</li>
</ul>
<p>支持redis、rabbitmq、mongo、mysql、SQLite、postgresql作为queue，支持同时使用flower作为可视化任务的管理后台。<br>管理平台的数据落地支持mongo、mysql、SQLite、postgresql.</p>
<h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[lavenderuni@~]<span class="comment"># pip install airflow</span></span><br><span class="line">pip install <span class="string">"airflow[crypto, password]"</span></span><br><span class="line">pip install <span class="string">"airflow[mysql]"</span></span><br><span class="line">pip install <span class="string">"airflow[hive]"</span></span><br><span class="line">pip install <span class="string">"airflow[celery]"</span></span><br><span class="line">pip install <span class="string">"airflow[rabbitmq]"</span></span><br></pre></td></tr></table></figure>

<h2 id="初始化管理平台的数据结构到mysql"><a href="#初始化管理平台的数据结构到mysql" class="headerlink" title="初始化管理平台的数据结构到mysql"></a>初始化管理平台的数据结构到mysql</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> airflow;</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">privileges</span> <span class="keyword">on</span> airflow.* <span class="keyword">to</span> <span class="string">'ct'</span>@<span class="string">'localhost'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'152108'</span>;</span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> mysql.user;</span><br><span class="line">airflow initdb <span class="comment"># 任意目录下执行</span></span><br><span class="line">cd ~/airflow/</span><br><span class="line">vi airflow.cfg <span class="comment"># 替换sql_alchemy_conn = mysql://ct:152108@localhost/airflow</span></span><br><span class="line">airflow initdb <span class="comment"># 再次执行</span></span><br></pre></td></tr></table></figure>

<h2 id="初始化数据"><a href="#初始化数据" class="headerlink" title="初始化数据"></a>初始化数据</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/airflow/</span><br><span class="line">vi airflow.cfg <span class="comment"># 替换broker_url = redis://127.0.0.1:6379/15</span></span><br><span class="line">和 celery_result_backend = redis://127.0.0.1:6379/16</span><br><span class="line"></span><br><span class="line">airflow webserver --debug &amp;</span><br><span class="line">airflow scheduler</span><br></pre></td></tr></table></figure>

<h2 id="设置执行任务的broker即queue"><a href="#设置执行任务的broker即queue" class="headerlink" title="设置执行任务的broker即queue"></a>设置执行任务的broker即queue</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/airflow/</span><br><span class="line">vi airflow.cfg <span class="comment"># 替换broker_url = redis://127.0.0.1:6379/15</span></span><br><span class="line">和 celery_result_backend = redis://127.0.0.1:6379/16</span><br><span class="line"></span><br><span class="line">airflow webserver --debug &amp;</span><br><span class="line">airflow scheduler</span><br></pre></td></tr></table></figure>

<h2 id="启动三大组件"><a href="#启动三大组件" class="headerlink" title="启动三大组件"></a>启动三大组件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">airflow webserver --debug &amp; <span class="comment">#启动管理平台，访问http://127.0.0.1:8080/</span></span><br><span class="line">airflow worker <span class="comment">#启动工作者</span></span><br><span class="line">airflow scheduler <span class="comment">#启动任务调度分发器</span></span><br></pre></td></tr></table></figure>

<p>管理平台如下图所示<br><img src="/2017/03/07/airflow1/airflow.png" alt="airflow"></p>
<p>airflow的dag文件例子参照testlab的<a href="https://github.com/listen-lavender/testlab/tree/master/airflow/dags" target="_blank" rel="noopener">airflow/dags</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DAG/">DAG</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/data-pipeline/">data pipeline</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/task-flow/">task flow</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/backend-tool/">backend-tool</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-zahuo" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/01/28/zahuo/" class="article-date">
  	<time datetime="2017-01-28T02:53:20.000Z" itemprop="datePublished">2017-01-28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/28/zahuo/">猿联</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <style>
    p{text-indent: 2em;}
    img[title="coder"] {width: 95%;}
</style>

<center style="font-size:2em;">猿联</center>

<p><img src="/2017/01/28/zahuo/coder.jpg" alt="coder"></p>
<center>
|  | 连年coding |  |
| :------:| :------: | :------: |
| 猴 | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 鸡 |
| 子 | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 群 |
| 补 | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 算 |
| 丁 | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 法 |
| 扫 | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 翻 |
| 除 | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 新 |
| 昔 | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 炼 |
| bug | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | need |
</center>


      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/新年快乐/">新年快乐</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/随心随性/">随心随性</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/杂货/">杂货</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2020 listen
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
    <script type="text/javascript">
      (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
      (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
      e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
      })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
      
      _st('install','hPJFSMYvMX8XnCRm-L2e','2.0.0');
    </script>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>