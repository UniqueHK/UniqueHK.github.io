<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>宽视角</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="年轻是什么？就是越挫越勇！">
<meta property="og:type" content="website">
<meta property="og:title" content="宽视角">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="宽视角">
<meta property="og:description" content="年轻是什么？就是越挫越勇！">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="宽视角">
<meta name="twitter:description" content="年轻是什么？就是越挫越勇！">
  
    <link rel="alternative" href="/atom.xml" title="宽视角" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	
		<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
			<label>Search</label>
			<input type="text" id="st-search-input" class="st-default-search-input st-search-input_my" maxlength="30" placeholder="Search" />
		</form>
	
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/4168558?v=3&amp;s=460" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">宽视角</a></h1>
		</hgroup>

		
        <h3 style="font-weight:bold;font-style:italic;" class="header-subtitle">listen</h3>
        

		
		<p class="header-subtitle">年轻是什么？就是越挫越勇！</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/listen-lavender" title="github">github</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/" style="font-size: 10px;">==</a> <a href="/tags/DAG/" style="font-size: 10px;">DAG</a> <a href="/tags/FP/" style="font-size: 10px;">FP</a> <a href="/tags/LRU-cache/" style="font-size: 10px;">LRU cache</a> <a href="/tags/Newton-iteration/" style="font-size: 10px;">Newton iteration</a> <a href="/tags/OOP/" style="font-size: 10px;">OOP</a> <a href="/tags/Slice分布式/" style="font-size: 10px;">Slice分布式</a> <a href="/tags/Time-Quantum/" style="font-size: 10px;">Time Quantum</a> <a href="/tags/async-task/" style="font-size: 10px;">async task</a> <a href="/tags/asynchronous/" style="font-size: 10px;">asynchronous</a> <a href="/tags/asyncio/" style="font-size: 10px;">asyncio</a> <a href="/tags/authority/" style="font-size: 10px;">authority</a> <a href="/tags/background/" style="font-size: 10px;">background</a> <a href="/tags/beanstalkd/" style="font-size: 10px;">beanstalkd</a> <a href="/tags/binary-search/" style="font-size: 10px;">binary search</a> <a href="/tags/bit/" style="font-size: 10px;">bit</a> <a href="/tags/bitmap/" style="font-size: 20px;">bitmap</a> <a href="/tags/brpop/" style="font-size: 10px;">brpop</a> <a href="/tags/cache-algorithm/" style="font-size: 10px;">cache algorithm</a> <a href="/tags/cell/" style="font-size: 10px;">cell</a> <a href="/tags/column/" style="font-size: 10px;">column</a> <a href="/tags/comet-streaming/" style="font-size: 10px;">comet streaming</a> <a href="/tags/complicated/" style="font-size: 10px;">complicated</a> <a href="/tags/concurrently/" style="font-size: 10px;">concurrently</a> <a href="/tags/context/" style="font-size: 10px;">context</a> <a href="/tags/coroutine/" style="font-size: 10px;">coroutine</a> <a href="/tags/csrf/" style="font-size: 10px;">csrf</a> <a href="/tags/data-pipeline/" style="font-size: 10px;">data pipeline</a> <a href="/tags/datamodel/" style="font-size: 10px;">datamodel</a> <a href="/tags/distributed/" style="font-size: 10px;">distributed</a> <a href="/tags/dynamic/" style="font-size: 10px;">dynamic</a> <a href="/tags/extract/" style="font-size: 10px;">extract</a> <a href="/tags/flexible/" style="font-size: 10px;">flexible</a> <a href="/tags/frame/" style="font-size: 10px;">frame</a> <a href="/tags/gen-coroutine/" style="font-size: 10px;">gen.coroutine</a> <a href="/tags/goroutine/" style="font-size: 10px;">goroutine</a> <a href="/tags/greenlet/" style="font-size: 10px;">greenlet</a> <a href="/tags/gunicorn/" style="font-size: 10px;">gunicorn</a> <a href="/tags/hashtable/" style="font-size: 10px;">hashtable</a> <a href="/tags/hash优化/" style="font-size: 10px;">hash优化</a> <a href="/tags/hash制度/" style="font-size: 10px;">hash制度</a> <a href="/tags/header/" style="font-size: 10px;">header</a> <a href="/tags/http1-0/" style="font-size: 10px;">http1.0</a> <a href="/tags/http1-1/" style="font-size: 10px;">http1.1</a> <a href="/tags/http2-0/" style="font-size: 10px;">http2.0</a> <a href="/tags/include/" style="font-size: 10px;">include</a> <a href="/tags/index/" style="font-size: 20px;">index</a> <a href="/tags/interface/" style="font-size: 10px;">interface</a> <a href="/tags/ioloop/" style="font-size: 10px;">ioloop</a> <a href="/tags/is/" style="font-size: 10px;">is</a> <a href="/tags/json/" style="font-size: 10px;">json</a> <a href="/tags/judge/" style="font-size: 10px;">judge</a> <a href="/tags/keyexpired/" style="font-size: 10px;">keyexpired</a> <a href="/tags/learning/" style="font-size: 10px;">learning</a> <a href="/tags/level/" style="font-size: 20px;">level</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/long-polling/" style="font-size: 10px;">long polling</a> <a href="/tags/lpush/" style="font-size: 10px;">lpush</a> <a href="/tags/lxml/" style="font-size: 10px;">lxml</a> <a href="/tags/mergelist/" style="font-size: 10px;">mergelist</a> <a href="/tags/method/" style="font-size: 10px;">method</a> <a href="/tags/mongo/" style="font-size: 10px;">mongo</a> <a href="/tags/mongo-id/" style="font-size: 10px;">mongo_id</a> <a href="/tags/monitor/" style="font-size: 10px;">monitor</a> <a href="/tags/mq通信/" style="font-size: 10px;">mq通信</a> <a href="/tags/multi-process/" style="font-size: 10px;">multi process</a> <a href="/tags/nosql/" style="font-size: 10px;">nosql</a> <a href="/tags/object-oriented/" style="font-size: 10px;">object-oriented</a> <a href="/tags/off-schedule/" style="font-size: 10px;">off-schedule</a> <a href="/tags/package/" style="font-size: 10px;">package</a> <a href="/tags/parallel/" style="font-size: 10px;">parallel</a> <a href="/tags/parametrized/" style="font-size: 10px;">parametrized</a> <a href="/tags/performance/" style="font-size: 10px;">performance</a> <a href="/tags/phantomjs/" style="font-size: 10px;">phantomjs</a> <a href="/tags/pointer/" style="font-size: 10px;">pointer</a> <a href="/tags/pointerarray/" style="font-size: 10px;">pointerarray</a> <a href="/tags/powerful/" style="font-size: 10px;">powerful</a> <a href="/tags/priority/" style="font-size: 20px;">priority</a> <a href="/tags/procedure-oriented/" style="font-size: 10px;">procedure-oriented</a> <a href="/tags/property/" style="font-size: 10px;">property</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/queue/" style="font-size: 10px;">queue</a> <a href="/tags/recursive-struct/" style="font-size: 10px;">recursive struct</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/regex/" style="font-size: 10px;">regex</a> <a href="/tags/requests/" style="font-size: 10px;">requests</a> <a href="/tags/row/" style="font-size: 10px;">row</a> <a href="/tags/rpc通信/" style="font-size: 10px;">rpc通信</a> <a href="/tags/rwx/" style="font-size: 10px;">rwx</a> <a href="/tags/setter-getter/" style="font-size: 10px;">setter/getter</a> <a href="/tags/shell-script/" style="font-size: 10px;">shell script</a> <a href="/tags/signatures/" style="font-size: 10px;">signatures</a> <a href="/tags/specific-type/" style="font-size: 10px;">specific type</a> <a href="/tags/sqrt/" style="font-size: 10px;">sqrt</a> <a href="/tags/task-flow/" style="font-size: 10px;">task flow</a> <a href="/tags/threading/" style="font-size: 10px;">threading</a> <a href="/tags/type-assert/" style="font-size: 10px;">type assert</a> <a href="/tags/urlparameter/" style="font-size: 10px;">urlparameter</a> <a href="/tags/websocket/" style="font-size: 10px;">websocket</a> <a href="/tags/weight/" style="font-size: 10px;">weight</a> <a href="/tags/worthy/" style="font-size: 10px;">worthy</a> <a href="/tags/上/" style="font-size: 10px;">上</a> <a href="/tags/两小无猜/" style="font-size: 10px;">两小无猜</a> <a href="/tags/乌托邦/" style="font-size: 10px;">乌托邦</a> <a href="/tags/人生半坡/" style="font-size: 10px;">人生半坡</a> <a href="/tags/优先级/" style="font-size: 10px;">优先级</a> <a href="/tags/使用场景/" style="font-size: 10px;">使用场景</a> <a href="/tags/先验概率/" style="font-size: 10px;">先验概率</a> <a href="/tags/全概率/" style="font-size: 10px;">全概率</a> <a href="/tags/冲突/" style="font-size: 10px;">冲突</a> <a href="/tags/减法/" style="font-size: 10px;">减法</a> <a href="/tags/分布式/" style="font-size: 10px;">分布式</a> <a href="/tags/分支限界/" style="font-size: 10px;">分支限界</a> <a href="/tags/分治/" style="font-size: 10px;">分治</a> <a href="/tags/分类/" style="font-size: 10px;">分类</a> <a href="/tags/动态规划/" style="font-size: 10px;">动态规划</a> <a href="/tags/努力/" style="font-size: 10px;">努力</a> <a href="/tags/匿名变量/" style="font-size: 10px;">匿名变量</a> <a href="/tags/单线程/" style="font-size: 10px;">单线程</a> <a href="/tags/后验概率/" style="font-size: 10px;">后验概率</a> <a href="/tags/周星驰/" style="font-size: 10px;">周星驰</a> <a href="/tags/哈希/" style="font-size: 10px;">哈希</a> <a href="/tags/回溯/" style="font-size: 10px;">回溯</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a> <a href="/tags/富类hash/" style="font-size: 10px;">富类hash</a> <a href="/tags/小巧/" style="font-size: 10px;">小巧</a> <a href="/tags/嵌入式脚本/" style="font-size: 10px;">嵌入式脚本</a> <a href="/tags/异步IO/" style="font-size: 10px;">异步IO</a> <a href="/tags/张小凡/" style="font-size: 10px;">张小凡</a> <a href="/tags/性能/" style="font-size: 10px;">性能</a> <a href="/tags/排序/" style="font-size: 10px;">排序</a> <a href="/tags/新年快乐/" style="font-size: 10px;">新年快乐</a> <a href="/tags/条件查询/" style="font-size: 10px;">条件查询</a> <a href="/tags/条件概率/" style="font-size: 10px;">条件概率</a> <a href="/tags/浮夸/" style="font-size: 10px;">浮夸</a> <a href="/tags/混沌hash/" style="font-size: 10px;">混沌hash</a> <a href="/tags/热加载/" style="font-size: 10px;">热加载</a> <a href="/tags/父类方法调用子类方法/" style="font-size: 10px;">父类方法调用子类方法</a> <a href="/tags/状态/" style="font-size: 10px;">状态</a> <a href="/tags/田灵儿/" style="font-size: 10px;">田灵儿</a> <a href="/tags/自省自乐/" style="font-size: 10px;">自省自乐</a> <a href="/tags/自虐/" style="font-size: 10px;">自虐</a> <a href="/tags/贪心/" style="font-size: 10px;">贪心</a> <a href="/tags/转码/" style="font-size: 10px;">转码</a> <a href="/tags/阻塞完成/" style="font-size: 10px;">阻塞完成</a> <a href="/tags/随心随性/" style="font-size: 10px;">随心随性</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://braavos.me/">落在深海</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://sanyuesha.com/">三月沙</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">listen</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="https://avatars1.githubusercontent.com/u/4168558?v=3&amp;s=460" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">listen</h1>
			</hgroup>
			
			<p class="header-subtitle">年轻是什么？就是越挫越勇！</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/listen-lavender" title="github">github</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-hashcountry" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/13/hashcountry/" class="article-date">
  	<time datetime="2016-08-13T00:51:59.000Z" itemprop="datePublished">2016-08-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/13/hashcountry/">哈希国度</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <style>
    p{text-indent: 2em;}
    img[title="utopia"] {width: 95%;}
</style>

<center style="font-size:2em;">哈希国度</center>

<p><img src="/2016/08/13/hashcountry/utopia.jpeg" alt="utopia"></p>
<p>人类和各种其他生物进化了几千年，按照现有的分布方式，地球的三维空间逐渐满足不了日益膨胀的发展。</p>
<p>渡渡鸟，蓝马羚，旅鸽，卡罗莱那鹦鹉，红鸭，普氏野马，袋狼…..很多动物，其实还有植物，都已经成为了传说，基本原因都是因为人类的活动范围扩张和无知造成的。动植物改造环境的效率低，所以具有很强的适应环境的能力，而人类改造环境的能力越来越强，效率越来越高，导致动植物完全适应不了人类的改造速度和改造范围，这是种间竞争，就是强势物种干掉弱势物种。</p>
<p>同时，人类自身规模的增长，导致种内斗争日益加剧，例如战争、和平时期的社会悲剧。动植物也有种内斗争，例如雄性求偶、争夺水源、撕抢食物…..整体而言，人类的种内斗争要比动植物世界来的复杂，范围更广，因为人类个体的活动范围也比动植物的要广，一个人类终其一生可能足迹遍布全球甚至外太空，然而动植物活动范围不过方圆几里。历史上大大小小的战争都是人类的种内斗争的体现，原因也是千奇百怪，有信仰引发的，有红颜引发的，有城池引发的，有理想引发的，还有误会引发的…..</p>
<p>在远古时代，人类和动植物的生存繁衍能力相差不大，至少是在上帝的控制范围之内，现代人觉得那个时候很和谐，地球很健康，因为大自然通过种间竞争和种内斗争平衡了一切生灵的发展状态，即使有物种灭绝也是大部分生灵的共同作用。而今人类的能力超前强大，人类的行为对所有生物的发展影响最大，包括自己。</p>
<p>人类该如何把握自身的发展，让地球维持健康呢？我觉得还是要从人类行为的效率出发，很多的人类行为都是盲目的，无序的，混沌的，导致了空间的浪费，资源的浪费，加剧了地球上的种间竞争和种内斗争，加速了各种灭亡。我是it从业者，业内有一种技术叫Hash，一般翻译做“散列”，也有音译为“哈希”的。哈希就是把任意长度的输入（又叫做预映射，pre-image），通过散列算法，变换成固定长度的输出，该输出就是散列值，是一种压缩映射的转换，散列值的空间通常远小于输入的空间。简单来说，就是一个萝卜一个坑，最好没有空的坑和没有坑的萝卜。</p>
<p>其实人类行为的分布，何尝不是一种哈希呢?</p>
<p>将地球看成存储空间，人类还有动植物分布在世界的角落，有很多地方是稀疏的，有很多地方是密集的，然而从哈希的角度看，都是不合理的，浪费的，所以导致了不平等，不和谐，不对称。像纽约、北京一类的大城市，聚集了大量的人口，即使是一城之内的分布也是不均匀的，就出现了贫民窟、城中村，衣食住行拥堵，民族主义仇杀等种种问题。还有人类的繁殖，盲目开垦，工业污染，科技污染等等，都是因为上帝无法控制人类的自主动态分布。而目前人类的自主依旧很盲目，导致人类占据了太多不需要的空间和资源，于是动植物的发展范围在缩小。这么多人类悲伤的事情，就像机器的hash冲突一样。</p>
<p>既然上帝无法控制了，人类自身已经掌握了权利，为什么要放任自己的行为的分布呢？我想上帝hash方式是一种混沌，而人类需要找出一种能自我理解，自我控制的hash方式，当然it界的很多hash方式尽管很优秀，还是无法应对人类发展以及地球发展需要的如此庞杂又动态的分布，毕竟it界的hash方式的空间都是简单的。</p>
<p>我们的社会制度、生活规则、科技工具、法律、道德、信仰、环保意识等等一些公约形态都可以看做人类hash方式的一部分，人类的hash是一种富类hash，只是还不够完备智能，还不足以处理巨大的地球数据，当然不能替代上帝的混沌hash方式。社会制度就是一种hash制度，国民们需要不断地积累经验教训，抓住社会问题的hash冲突本质，而不是经过通过忍让、逃避、欺骗、忘记来解决问题。发展出一套完备的hash制度能让国家变成哈希国度，也许就是一些哲学家梦里的乌托邦。</p>
<p>如果有一天人类的富类hash方式能够取代上帝的混沌hash方式，就能像大自然一样主动调节达到地球的平衡发展。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hash制度/">hash制度</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/乌托邦/">乌托邦</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/冲突/">冲突</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/哈希/">哈希</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/富类hash/">富类hash</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/混沌hash/">混沌hash</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/杂货/">杂货</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-asyncexe" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/13/asyncexe/" class="article-date">
  	<time datetime="2016-08-12T16:47:23.000Z" itemprop="datePublished">2016-08-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/13/asyncexe/">协程和异步IO</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>TODO</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/asyncio/">asyncio</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/coroutine/">coroutine</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/greenlet/">greenlet</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ioloop/">ioloop</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/python/">python</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-tornado1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/13/tornado1/" class="article-date">
  	<time datetime="2016-08-12T16:46:15.000Z" itemprop="datePublished">2016-08-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/13/tornado1/">tornado</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>tornado是异步IO服务框架，当然并不是严格的异步IO。IOCP才是真正的异步IO，主要在windows系统里面。<br>tornado的异步在于通过Python select模块的epoll/kqueue实现了非阻塞，默认是水平触发(Level Triggered)，在承载一定的访问压力下保证性能和稳定。nginx常用来做反向代理，要承担大量的外部访问请求，默认是边缘出发的(Edge Triggered)。</p>
<p>具体实现在于IOLoop，IOStream，asynchronous和gen.coroutine。</p>
<h2 id="IOLoop"><a href="#IOLoop" class="headerlink" title="IOLoop"></a>IOLoop</h2><p>IOLoop初始化时创建一个Waker对象，将Waker对象fd的读端注册到事件循环中并设定相应的回调函数，当事件循环阻塞而没有响应描述符出现，会在最大timeout时间之前返回，向管道写入字符’x’唤醒阻塞，同时在IOLoop的stop函数中调用self._waker.wake()，停止事件循环。</p>
<p>add_handler方法使用stack_context提供的wrap方法，返回一个可以直接调用的对象并且保存传入之前的堆栈信息，在执行时恢复，保证了函数的异步调用在正确的运行环境。</p>
<p>IOLoop的核心调度start方法中，IOLoop实例对象调用start后开始epoll事件循环机制，一直运行直到 IOLoop对象调用stop函数。<br>start方法中主要分三个部分：对超时的相关处理；epoll事件通知阻塞、接收；对epoll返回I/O事件的处理。</p>
<ul>
<li>为了实现异步，将回调函数延迟到下一轮事件循环中执行。</li>
<li>超时的处理使用heapq，记录每个回调函数的超时时间(deadline)，每次弹出deadline最小的回调函数，如果callback标志位为True且已超时，通过_run_callback调用函数；如果没有超时重新设定poll_timeout的值。</li>
<li>通过self._impl.poll(poll_timeout)进行事件阻塞，当有事件通知或超时，poll返回特定的event_pairs。</li>
<li>epoll返回通知事件后将新事件加入待处理队列，将就绪事件逐个弹出，通过stack_context.wrap(handler)保存的可执行对象以及执行上下文调用事件处理。</li>
</ul>
<h2 id="IOStream"><a href="#IOStream" class="headerlink" title="IOStream"></a>IOStream</h2><p>IOStream使用deque容器和_merge_prefix(deque, size)函数封装socket的非阻塞IO的读写操作，包括数据的缓存和重组，read_util()接口设置一个标志字符串和回调函数，当IOStream读到标志字符串时自动调用该回调函数，做数据的分片处理。</p>
<p>tornado的tcpserver使用IOStream，httpserver通过tcpserver实现，同理httpclient也是如此。</p>
<h2 id="asynchronous"><a href="#asynchronous" class="headerlink" title="asynchronous"></a>asynchronous</h2><p>被@asynchronous装饰的handler，会使http请求成为长连接(tcp长连接要注意粘包问题，http长连接可能自带解决方案)，一直处于等待状态，直到调用self.finish()结束请求，优势在于不会阻塞其他的http请求的访问。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DebugHandler</span><span class="params">(RequestHandler)</span>:</span></span><br><span class="line"><span class="meta">    @asynchronous</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        http_client = AsyncHTTPClient()</span><br><span class="line">        http_client.fetch(<span class="string">"http://example.com"</span>, callback=self.on_fetch)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_fetch</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        do_something_with_response(response)</span><br><span class="line">        self.render(<span class="string">"template.html"</span>)</span><br></pre></td></tr></table></figure>

<p>注意例子中，self.render方法的实现最后调用了self.finish。</p>
<h2 id="gen-coroutine"><a href="#gen-coroutine" class="headerlink" title="gen.coroutine"></a>gen.coroutine</h2><p>被@asynchronous装饰的handler是同步的代码异步执行，tornado3以后，强化coroutine，替代了gen.engine+asynchronous，简化在handler异步编程，避免写回调函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DebugHandler</span><span class="params">(RequestHandler)</span>:</span></span><br><span class="line"><span class="meta">    @gen.coroutine</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        http_client = AsyncHTTPClient()</span><br><span class="line">        response = <span class="keyword">yield</span> http_client.fetch(<span class="string">"http://example.com"</span>)</span><br><span class="line">        do_something_with_response(response)</span><br><span class="line">        self.render(<span class="string">"template.html"</span>)</span><br></pre></td></tr></table></figure>

<p>注意上面两个例子是等价的。<br>tornado的coroutine靠python中generator的send和yield挂起实现。第一次next()返回yield结果，并将程序挂起，等待send或者next方法唤醒，继续执行，send可以在function的执行过程中做外部输入同是触发yield，next只能触发yield取返回值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Generator</span><span class="params">()</span>:</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        m = <span class="keyword">yield</span> i</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'receive m'</span>, m</span><br><span class="line">        i += m</span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">g = Generator()</span><br><span class="line">result = g.next()</span><br><span class="line"><span class="keyword">print</span> <span class="string">'yield i'</span>, result</span><br><span class="line">result = g.send(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'yield i'</span>, result</span><br><span class="line">result = g.send(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'yield i'</span>, result</span><br><span class="line">result = g.send(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'yield i'</span>, result</span><br></pre></td></tr></table></figure>

<p>上面的例子体现yield的神奇。</p>
<p>asynchronous和gen.coroutine混用要注意Callback和Wait/WaitAll里面的key，可以通过Callback在不同的时候启动多个并行的异步操作，并且执行key关联的等待操作。如果Callback没有参数，对应的Wait就没有返回值；如果Callback有固定的参数，对应的Wait的返回值就是参数，类似C#的out参数；如果Callback传入变长参数，返回值就是元组(args, kwargs)。</p>
<p>asynchronous和gen.coroutine混用还可以给IOLoop里的callback安排优先级。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/asynchronous/">asynchronous</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gen-coroutine/">gen.coroutine</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/object-oriented/">object-oriented</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/单线程/">单线程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/异步IO/">异步IO</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-flask1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/12/flask1/" class="article-date">
  	<time datetime="2016-08-12T14:49:09.000Z" itemprop="datePublished">2016-08-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/12/flask1/">flask</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>flask是同步IO服务框架，通过werkzeug调用Python SocketServer，SocketServer调用Python select模块的select实现，因此是阻塞的。</p>
<h2 id="MethodView"><a href="#MethodView" class="headerlink" title="MethodView"></a>MethodView</h2><p>flask一般情况直接用function组织handler就可以，但是flask也支持类handler来组织，在flask里面叫 MethodView。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserAPI</span><span class="params">(MethodView)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, user_id)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> user_id <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 返回一个包含所有用户的列表</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 显示一个用户</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 创建一个新用户</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, user_id)</span>:</span></span><br><span class="line">        <span class="comment"># 删除一个用户</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, user_id)</span>:</span></span><br><span class="line">        <span class="comment"># update a single user</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">user_view = UserAPI.as_view(<span class="string">'user_api'</span>)</span><br><span class="line">app.add_url_rule(<span class="string">'/users/'</span>, defaults=&#123;<span class="string">'user_id'</span>: <span class="literal">None</span>&#125;,</span><br><span class="line">                 view_func=user_view, methods=[<span class="string">'GET'</span>,])</span><br><span class="line">app.add_url_rule(<span class="string">'/users/'</span>, view_func=user_view, methods=[<span class="string">'POST'</span>,])</span><br><span class="line">app.add_url_rule(<span class="string">'/users/&lt;int:user_id&gt;'</span>, view_func=user_view,</span><br><span class="line">                 methods=[<span class="string">'GET'</span>, <span class="string">'PUT'</span>, <span class="string">'DELETE'</span>])</span><br></pre></td></tr></table></figure>

<h2 id="blinker"><a href="#blinker" class="headerlink" title="blinker"></a>blinker</h2><p><a href="http://pythonhosted.org/blinker/" target="_blank" rel="noopener">blinker</a>在执行环境中，提供快捷的object-to-object和broadcast信号</p>
<ul>
<li>全局信号，通知相关的对象操作</li>
<li>匿名信号</li>
<li>自定义信号</li>
<li>永久或者临时地连接接收者</li>
<li>通过弱引用weak referencing，自动断开连接</li>
<li>因为是内存的数据通信，支持任意数据格式</li>
<li>从接收者手机数据</li>
<li>线程安全</li>
</ul>
<h2 id="gunicorn"><a href="#gunicorn" class="headerlink" title="gunicorn"></a>gunicorn</h2><p>Gunicorn是一个Python WSGI UNIX的HTTP服务器，是pre-fork worker的模型，从Ruby的unicorn项目移植，与各种Web框架兼容，配用简单，资源消耗轻量级，抗压能力强。</p>
<ul>
<li>本身支持WSGI、Django、Paster</li>
<li>自动辅助进程管理</li>
<li>简单的 Python配置</li>
<li>允许配置多个工作环境</li>
<li>各种服务器的可扩展钩子</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gunicorn/">gunicorn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/procedure-oriented/">procedure-oriented</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多线程/">多线程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/小巧/">小巧</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-zhuxian1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/11/zhuxian1/" class="article-date">
  	<time datetime="2016-08-11T02:14:15.000Z" itemprop="datePublished">2016-08-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/11/zhuxian1/">诛仙</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <style>
    p{text-indent: 2em;}
    img[title="mistake"] {width: 95%;}
</style>

<center style="font-size:2em;">诛仙之两小无猜</center>

<p><img src="/2016/08/11/zhuxian1/mistake.jpg" alt="mistake"></p>
<p>青梅竹马，语出唐李白《长干行》之一：“郎骑竹马来，绕床弄青梅。同居长干里 ，两小无嫌猜。”后以“青梅竹马”形容男女儿童之间两小无猜的情状，一般长大后都是牵着别人的手，或者偎在别人的怀里，偶尔想念竹马，偶尔想念青梅。</p>
<p>张小凡与田灵儿的青梅竹马情是很平淡有味的。</p>
<p>张小凡的悲惨遭遇从小时候开始，平淡幸福的村庄生活被毁，和林惊羽被带上青云山后，完全处于两种不同的待遇。林惊羽是山上师傅争相抢夺的香饽饽，而张小凡是没人要的蠢蛋，最后被道玄强塞到大竹峰田不易门下，这也算是张小凡幸运的开始。</p>
<p>都说时间能治愈一切，只说对了一半，还要看时间带来了什么。如果时间带来的依然是伤痛，却是会抹掉你过去的伤痛，那是因为你越来越麻木了，新的伤痛让你忘却旧的伤痛，而且是新的伤痛大于旧的伤痛。大竹峰上，田不易虽然恨铁不成钢，但是对徒弟还是关爱的，除了骂骂叨叨，也不会强迫弟子成才。张小凡挨得骂，估计是最多的，这有什么关系，至少还能感受到长辈的关怀，替代了双亲的一种生活存在。一群师兄弟，是不争气，天天都乐呵呵的，也挺好，多年以后的张小凡牛逼哄哄的，又怎么样呢，他还是怀念过往的平淡。</p>
<p>我不喜欢李易峰，唐艺昕挺不错的。《青云志》里面唐艺昕饰演的田灵儿，在张小凡上山后给予了及时的照顾，她的热情，她的活泼，她的烂漫，轻松地将张小凡的注意力从悲伤里面转移出来，使张小凡经历不正常的遭遇后，能正常地成长。她和张小凡练剑的情景，让我想起了《笑傲江湖》的令狐冲和岳灵珊，不一样的是田灵儿是张小凡的师姐，是骄纵的田灵儿在关心张小凡，虽然未必到位，令狐冲是岳灵珊的师兄，令狐冲多半是关心容纳师妹的骄纵，令狐冲当然不用师妹照顾。所以张小凡对田灵儿的依赖要大于令狐冲对岳灵珊的依赖。令狐冲旷达灵动，有一帮酒肉朋友可以解闷。张小凡比较呆笨，没什么朋友，只能自说自话。</p>
<p>李易峰饰演的张小凡，在与田灵儿这一段情的演绎上，还是挺到位的，对田灵儿的默默关怀，对田灵儿蠢蠢欲动的表白，对田灵儿每每诉说关于齐昊的心事的无奈，不需要太多的言语，全在眼神动作里，全在虹桥的寂寞夜色里。</p>
<p>田灵儿虽然没心没肺的直率，但是对于感情，还是比较认真，认准。最后田灵儿也收获了满满的幸福，不像岳灵珊最后惨兮兮的坚贞。</p>
<p>张小凡一直将这段感情埋在心底，望着田灵儿奔向齐昊的背影说：“青梅是酸涩的，就由她去吧，只要她好。”</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/两小无猜/">两小无猜</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/张小凡/">张小凡</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/田灵儿/">田灵儿</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/杂货/">杂货</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-gotest1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/10/gotest1/" class="article-date">
  	<time datetime="2016-08-10T13:54:38.000Z" itemprop="datePublished">2016-08-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/10/gotest1/">go二分法和牛顿迭代法求平方根</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <style>
    img[title="newton"] {width: 10%;}
</style>

<h2 id="二分法"><a href="#二分法" class="headerlink" title="二分法"></a>二分法</h2><ul>
<li>求根号5</li>
<li>折半:5/2=2.5</li>
<li>平方校验: 2.5*2.5=6.25&gt;5，并且得到当前上限2.5</li>
<li>再次向下折半:2.5/2=1.25</li>
<li>平方校验:1.25*1.25=1.5625&lt;5,得到当前下限1.25</li>
<li>再次折半:2.5-(2.5-1.25)/2=1.875</li>
<li>平方校验:1.875*1.875=3.515625&lt;5,得到当前下限1.875</li>
</ul>
<h2 id="牛顿迭代法"><a href="#牛顿迭代法" class="headerlink" title="牛顿迭代法"></a>牛顿迭代法</h2><p><img src="/2016/08/10/gotest1/newton.png" alt="newton"><br>可以理解函数f(x) = x²，使f(x) = num的近似解，即x² - num = 0的近似解。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"math"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewtonSqrt</span><span class="params">(num <span class="keyword">float64</span>)</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">    x := num / <span class="number">2.0</span></span><br><span class="line">    <span class="keyword">var</span> y <span class="keyword">float64</span> = <span class="number">0</span></span><br><span class="line">    count := <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> math.Abs(x-y) &gt; <span class="number">0.00000001</span>&#123;</span><br><span class="line">        <span class="comment">// fmt.Println(count, x)</span></span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        y = x</span><br><span class="line">        x = (<span class="number">1.0</span>/<span class="number">2.0</span>)*x+(num*<span class="number">1.0</span>)/(x*<span class="number">2.0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BinarySqrt</span><span class="params">(num <span class="keyword">float64</span>)</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">    y := num/<span class="number">2.0</span>  </span><br><span class="line">    low := <span class="number">0.0</span>  </span><br><span class="line">    up := num</span><br><span class="line">    count := <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> math.Abs(y * y - num) &gt; <span class="number">0.00000001</span>&#123;</span><br><span class="line">        <span class="comment">// fmt.Println(count, y)</span></span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> y*y &gt; num&#123;</span><br><span class="line">            up = y</span><br><span class="line">            y = low+(y-low)/<span class="number">2</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            low = y</span><br><span class="line">            y = up-(up-y)/<span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"math sqrt"</span>, math.Sqrt(<span class="number">5</span>))</span><br><span class="line">    fmt.Println(<span class="string">"Newton sqrt"</span>, NewtonSqrt(<span class="number">5</span>))</span><br><span class="line">    fmt.Println(<span class="string">"binary sqrt"</span>, BinarySqrt(<span class="number">5</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>精度0.00000001，在亿分之一；<br>二分法经过27次迭代；<br>牛顿法只迭代了3次，是二分法的十倍；<br>系统sqrt是最快最准的，不知道采用了什么原理实现的？</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Newton-iteration/">Newton iteration</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/binary-search/">binary search</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sqrt/">sqrt</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/go/">go</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-celery1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/08/celery1/" class="article-date">
  	<time datetime="2016-08-08T03:51:16.000Z" itemprop="datePublished">2016-08-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/08/celery1/">celery之Chains, Groups, Chords, Map &amp; Starmap, Chunks</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>celery是一个独立的server进程，可以用redis、rabbitmq、mongo作为queue，flower是可视化的管理后台。<br>如下调用task装饰的func.apply_async就是异步执行，或者调用send_task。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[lavenderuni@~]<span class="comment"># celery multi start w1 -A asynctask -l info -c 1</span></span><br><span class="line">celery multi v3.1.23 (Cipater)</span><br><span class="line">&gt; Starting nodes...</span><br><span class="line">&lt;class <span class="string">'asynctask.lib.DefaultRegistry'</span>&gt;</span><br><span class="line">    &gt; w1@LavenderUnideMacBook-Pro.local: OK</span><br><span class="line"></span><br><span class="line">[lavenderuni@~]<span class="comment"># celery multi stop w1 -A asynctask -l info</span></span><br><span class="line">celery multi v3.1.23 (Cipater)</span><br><span class="line">&gt; w1@LavenderUnideMacBook-Pro.local: DOWN</span><br></pre></td></tr></table></figure>

<p>以上是启动停用命令，项目实例参照<a href="https://github.com/listen-lavender/asynctask" target="_blank" rel="noopener">asynctask</a>，-l参数是日志输出等级控制(debug是调试模式，会输出更多执行详情信息，生产环境不要轻易开启debug模式)，-c是并发进程数目控制。</p>
<p>通过celery的Chains, Groups, Chords, Map &amp; Starmap, Chunks，可以组合出各种复杂的任务。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">app = Celery(<span class="string">"task"</span>, backend=<span class="string">"redis://localhost:6379/1"</span>, broker=<span class="string">"redis://localhost:6379/0"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tsum</span><span class="params">(numbers)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(numbers)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trange</span><span class="params">(limit)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> range(limit)</span><br><span class="line"></span><br><span class="line">result = add.apply_async((<span class="number">2</span>, <span class="number">2</span>), link=add.s(<span class="number">16</span>))</span><br></pre></td></tr></table></figure>

<h2 id="Chains"><a href="#Chains" class="headerlink" title="Chains"></a>Chains</h2><p>串行调用，可以将signature任务按照顺序执行，前一个任务的输出是后一个任务的输入，结果是最后一个signature任务的输出。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> chain</span><br><span class="line"></span><br><span class="line">result = chain(add.s(<span class="number">2</span>, <span class="number">2</span>), add.s(<span class="number">4</span>), add.s(<span class="number">8</span>))() <span class="comment"># 2 + 2 + 4 + 8</span></span><br><span class="line">result.get() <span class="comment"># 16</span></span><br><span class="line">result.parent.parent.graph</span><br><span class="line"><span class="comment"># cd959635-47d2-4368-bdf1-ab969f9ce0e4(1)</span></span><br><span class="line"><span class="comment">#      6681c6b6-bc34-44b4-8c9f-7ad132ffa5f3(0)</span></span><br><span class="line"><span class="comment"># 6681c6b6-bc34-44b4-8c9f-7ad132ffa5f3(0)</span></span><br><span class="line"><span class="comment"># 87eac0e5-1f1b-4c0d-a27a-dbf7e7ccd925(2)</span></span><br><span class="line"><span class="comment">#      cd959635-47d2-4368-bdf1-ab969f9ce0e4(1)</span></span><br><span class="line"><span class="comment">#           6681c6b6-bc34-44b4-8c9f-7ad132ffa5f3(0)</span></span><br></pre></td></tr></table></figure>

<h2 id="Groups"><a href="#Groups" class="headerlink" title="Groups"></a>Groups</h2><p>并行调用，可以让signature并行执行，返回的结果是所有signature任务返回结果组成的数组。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> group</span><br><span class="line"></span><br><span class="line">result = group(add.s(<span class="number">2</span>, <span class="number">2</span>), add.s(<span class="number">4</span>, <span class="number">4</span>), add.s(<span class="number">8</span>, <span class="number">8</span>))() <span class="comment"># 2 + 2, 4 + 4, 8 + 8</span></span><br><span class="line">result.get() <span class="comment"># [14, 8, 16]</span></span><br></pre></td></tr></table></figure>

<h2 id="Chords"><a href="#Chords" class="headerlink" title="Chords"></a>Chords</h2><p>先并行调用，再串行调用，把并行signature任务的结果列表输入到串行调用，进行汇总，是reduce过程。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> group, chain, chord</span><br><span class="line"></span><br><span class="line">result = chain(group(add.s(<span class="number">2</span>, <span class="number">2</span>), add.s(<span class="number">4</span>, <span class="number">4</span>), add.s(<span class="number">8</span>, <span class="number">8</span>)), tsum.s())() <span class="comment"># sum([2 + 2, 4 + 4, 8 + 8])</span></span><br><span class="line">result.get() <span class="comment"># 28</span></span><br><span class="line"></span><br><span class="line">result = chord((add.s(<span class="number">2</span>, <span class="number">2</span>), add.s(<span class="number">4</span>, <span class="number">4</span>), add.s(<span class="number">8</span>, <span class="number">8</span>)), tsum.s())()</span><br><span class="line">result.get() <span class="comment"># 28</span></span><br></pre></td></tr></table></figure>

<h2 id="Map-amp-Starmap"><a href="#Map-amp-Starmap" class="headerlink" title="Map &amp; Starmap"></a>Map &amp; Starmap</h2><ul>
<li><p>Map，对并行调用的结果各自汇总</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~tsum.map([range(<span class="number">2</span>), range(<span class="number">2</span>), range(<span class="number">2</span>)]) <span class="comment"># [1, 1, 1]</span></span><br><span class="line">result = chain(trange.s(<span class="number">2</span>), group(tsum.s(), tsum.s(), tsum.s()))()</span><br><span class="line">result.get() <span class="comment"># [1, 1, 1]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Starmap，对并行调用的结果各自汇总，汇总参数是tuple，相当于*args</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~add.starmap(zip(range(<span class="number">10</span>), range(<span class="number">10</span>))) <span class="comment"># [0, 2, 4, 6, 8, 10, 12, 14, 16, 18]</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Chunks"><a href="#Chunks" class="headerlink" title="Chunks"></a>Chunks</h2><p>对大任务进行分割，分成小块执行，提高性能，将结果收集成列表。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">result = add.chunks(zip(range(<span class="number">100</span>), range(<span class="number">100</span>)), <span class="number">10</span>)()</span><br><span class="line">result.get()</span><br><span class="line"><span class="comment">#[[0, 2, 4, 6, 8, 10, 12, 14, 16, 18],</span></span><br><span class="line"><span class="comment"># [20, 22, 24, 26, 28, 30, 32, 34, 36, 38],</span></span><br><span class="line"><span class="comment"># [40, 42, 44, 46, 48, 50, 52, 54, 56, 58],</span></span><br><span class="line"><span class="comment"># [60, 62, 64, 66, 68, 70, 72, 74, 76, 78],</span></span><br><span class="line"><span class="comment"># [80, 82, 84, 86, 88, 90, 92, 94, 96, 98],</span></span><br><span class="line"><span class="comment"># [100, 102, 104, 106, 108, 110, 112, 114, 116, 118],</span></span><br><span class="line"><span class="comment"># [120, 122, 124, 126, 128, 130, 132, 134, 136, 138],</span></span><br><span class="line"><span class="comment"># [140, 142, 144, 146, 148, 150, 152, 154, 156, 158],</span></span><br><span class="line"><span class="comment"># [160, 162, 164, 166, 168, 170, 172, 174, 176, 178],</span></span><br><span class="line"><span class="comment"># [180, 182, 184, 186, 188, 190, 192, 194, 196, 198]]</span></span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/async-task/">async task</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/powerful/">powerful</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/backend-tool/">backend-tool</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-spider3" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/08/spider3/" class="article-date">
  	<time datetime="2016-08-08T03:50:06.000Z" itemprop="datePublished">2016-08-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/08/spider3/">爬虫之路（3）</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="任务去重"><a href="#任务去重" class="headerlink" title="任务去重"></a>任务去重</h2><ul>
<li>少量数据，比如几万或者十几万条的情况，使用Map或Set</li>
<li>中量数据，比如几百万或者上千万，使用BloomFilter</li>
<li>大量数据，上亿或者几十亿，<a href="https://github.com/listen-lavender/bloomfilter-redis/blob/master/bloomfilter.py" target="_blank" rel="noopener">Redis+BloomFilter</a>可以解决，getbit、setbit天生支持bitmap，注意redis的bitmap只支持2^32大小，对应到内存也就是512MB，数组的下标最大只能是2^32-1，这个限制可以通过构建多个redis的bitmap突破</li>
</ul>
<h3 id="bitmap"><a href="#bitmap" class="headerlink" title="bitmap"></a>bitmap</h3><p>bitmap用一个bit位来标记某个元素对应的value，而key即是这个元素。由于采用bit存储数据，因此大大节省存储空间，利用少量的时间来换取大量的空间，从而完成大量数据的排序、查询和逻辑运算。</p>
<p>Bloom Filter<br>将原数据通过随机映射函数映射到一个很长的二进制向量，布隆过滤器可用于检索一个元素是否在一个集合中，时间复杂度和空间复杂度的综合指标远远优于一般算法，但由于哈希冲突和数据量的增加，导致一定的误识别率，如果Bloom Filter报告某个元素不在集合中，则以一定不在；如果报告该元素在集合中，有可能在或者不在；可以增加多个bitmap，关联不同的hash函数，取否定的交集来提高bloom filter的准确率。<br><a href="https://github.com/jaybaird/python-bloomfilter" target="_blank" rel="noopener">python版本BloomFilter</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from pybloom import BloomFilter</span><br><span class="line">&gt;&gt;&gt; f = BloomFilter(capacity=1000, error_rate=0.001)</span><br><span class="line">&gt;&gt;&gt; [f.add(x) <span class="keyword">for</span> x <span class="keyword">in</span> range(10)]</span><br><span class="line">[False, False, False, False, False, False, False, False, False, False]</span><br><span class="line">&gt;&gt;&gt; all([(x <span class="keyword">in</span> f) <span class="keyword">for</span> x <span class="keyword">in</span> range(10)])</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; 10 <span class="keyword">in</span> f</span><br><span class="line">False</span><br><span class="line">&gt;&gt;&gt; 5 <span class="keyword">in</span> f</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; f = BloomFilter(capacity=1000, error_rate=0.001)</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">for</span> i <span class="keyword">in</span> xrange(0, f.capacity):</span><br><span class="line">...     _ = f.add(i)</span><br><span class="line">&gt;&gt;&gt; (1.0 - (len(f) / <span class="built_in">float</span>(f.capacity))) &lt;= f.error_rate + 2e-18</span><br><span class="line">True</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; from pybloom import ScalableBloomFilter</span><br><span class="line">&gt;&gt;&gt; sbf = ScalableBloomFilter(mode=ScalableBloomFilter.SMALL_SET_GROWTH)</span><br><span class="line">&gt;&gt;&gt; count = 10000</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">for</span> i <span class="keyword">in</span> xrange(0, count):</span><br><span class="line">...     _ = sbf.add(i)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt; (1.0 - (len(sbf) / <span class="built_in">float</span>(count))) &lt;= sbf.error_rate + 2e-18</span><br><span class="line">True</span><br></pre></td></tr></table></figure>

<p>将抓取流程的数据的特征串散列到bit map上面，根据bit map检测去重。</p>
<h3 id="primary-key-id"><a href="#primary-key-id" class="headerlink" title="primary key(id)"></a>primary key(id)</h3><p>利用数据库本身支持的唯一性字段，将抓取流程的数据的特征串转成md5，作为mongo的主键_id即可去重，或者其他数据库unique index.</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bitmap/">bitmap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongo-id/">mongo_id</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/spider/">spider</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-spider2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/03/spider2/" class="article-date">
  	<time datetime="2016-08-03T00:38:54.000Z" itemprop="datePublished">2016-08-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/03/spider2/">爬虫之路（2）</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="爬虫队列"><a href="#爬虫队列" class="headerlink" title="爬虫队列"></a>爬虫队列</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Queue</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, .....)</span>:</span></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_init</span><span class="params">(self, ......)</span>:</span></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_put</span><span class="params">(self, ......)</span>:</span></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get</span><span class="params">(self, ......)</span>:</span></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">task_done</span><span class="params">(self, ......)</span>:</span></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">join</span><span class="params">(self)</span>:</span></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>队列主要为了支持多线程间的通信，set、get同步，有task_done，有join，能支持查询和热操作就最好。</p>
<h3 id="queue"><a href="#queue" class="headerlink" title="queue"></a>queue</h3><p>优先级，单进程阻塞完成，不支持分布式，无状态，不支持条件查询</p>
<p>Python的标准队列支持Queue(FIFO)，LifoQueue(LIFO)，PriorityQueue(Priority) 三种队列，其中Queue和LifoQueue支持join。PriorityQueue是通过heapq实现的大顶堆、小顶堆来支持优先级。</p>
<p>因此如果程序需要priority和join功能，就通过继承Queue，自定义_put和_get的方式实现。</p>
<h3 id="beanstalkd"><a href="#beanstalkd" class="headerlink" title="beanstalkd"></a>beanstalkd</h3><p>beanstalkd支持0到2**32的优先级，值越小，优先级越高，默认优先级为1024；通过binlog将job及其状态记录到文件里面，在Beanstalkd下次启动时可以通过读取binlog来恢复之前的job及状态；服务端的原子操作同步支持客户端分布式。</p>
<h3 id="redis-queue"><a href="#redis-queue" class="headerlink" title="redis-queue"></a>redis-queue</h3><p>通过多list的原子操作blpop、brpop实现优先级有限的队列。</p>
<h3 id="mongo-queue"><a href="#mongo-queue" class="headerlink" title="mongo-queue"></a>mongo-queue</h3><p>通过原子操作find_and_modify和状态字段实现队列，有排序字段支持优先级。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/beanstalkd/">beanstalkd</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongo/">mongo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/queue/">queue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/">redis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/优先级/">优先级</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分布式/">分布式</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/条件查询/">条件查询</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/状态/">状态</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/阻塞完成/">阻塞完成</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/spider/">spider</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-queue2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/02/queue2/" class="article-date">
  	<time datetime="2016-08-02T10:18:38.000Z" itemprop="datePublished">2016-08-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/02/queue2/">redis队列</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>redis的list支持brpop、blpop，所以能实现队列，fifo、lifo、priority队列可以直接由lpush/rpush和brpop/blpop的组合实现。</p>
<ol>
<li>fifo和lifo队列，用一个key的list就行了，只做参考。更复杂的功能如get的block、timeout可以照着redis api实现就行了，队列的block需要用到lock，event之类的。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FifoRedisQ</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host=<span class="string">'localhost'</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>, label=<span class="string">'test'</span>)</span>:</span></span><br><span class="line">        self.r = redis.Redis(host=host, port=port, db=db)</span><br><span class="line">        self.label = label</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.r.brpop(self.label)[<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        self.r.lpush(self.label, item)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LifoRedisQ</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host=<span class="string">'localhost'</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>, label=<span class="string">'test'</span>)</span>:</span></span><br><span class="line">        self.r = redis.Redis(host=host, port=port, db=db)</span><br><span class="line">        self.label = label</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.r.blpop(self.label)[<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        self.r.lpush(self.label, item)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    fifoq = FifoRedisQ()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'----first in first out'</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">10</span>):</span><br><span class="line">        fifoq.put(k)</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">10</span>):</span><br><span class="line">        <span class="keyword">print</span> fifoq.get()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'----last in first out'</span></span><br><span class="line">    lifoq = LifoRedisQ()</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">10</span>):</span><br><span class="line">        lifoq.put(k)</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">10</span>):</span><br><span class="line">        <span class="keyword">print</span> lifoq.get()</span><br></pre></td></tr></table></figure>


<ol start="2">
<li>priority队列，每一个优先级需要用一个key对应一个list，每一个list就是存储该等级的数据channel。有多少种优先级是提前设定好的，不能动态添加。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis, random</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PriorityRedisQ</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host=<span class="string">'localhost'</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>, label=<span class="string">'test'</span>, weight=[])</span>:</span></span><br><span class="line">        self.r = redis.Redis(host=host, port=port, db=db)</span><br><span class="line">        self.label = label</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> weight:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"Please set weight of queue."</span>)</span><br><span class="line">        self.weight = weight</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.r.brpop([<span class="string">'_'</span>.join([self.label, str(one)]) <span class="keyword">for</span> one <span class="keyword">in</span> self.weight])[<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, priority, item)</span>:</span></span><br><span class="line">        self.r.lpush(<span class="string">'_'</span>.join([self.label, str(priority)]), (priority, item))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    weight = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">    prq = PriorityRedisQ(weight=weight)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'----priority'</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">10</span>):</span><br><span class="line">        prq.put(random.choice(weight), k)</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">10</span>):</span><br><span class="line">        <span class="keyword">print</span> prq.get()</span><br></pre></td></tr></table></figure>

<p>市面上有那么多好用的队列，你可以不选redis，看具体的业务需要吧，参考webcrawl的<a href="https://github.com/listen-lavender/webcrawl/blob/master/webcrawl/queue/redis.py" target="_blank" rel="noopener">redis priority queue</a>。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/brpop/">brpop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/level/">level</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lpush/">lpush</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/priority/">priority</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/backend-tool/">backend-tool</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2020 listen
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
    <script type="text/javascript">
      (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
      (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
      e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
      })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
      
      _st('install','hPJFSMYvMX8XnCRm-L2e','2.0.0');
    </script>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>